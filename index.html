<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
      :root { --primary: #4361ee; --bg: #f8f9fa; --text: #212529; }
      body { font-family: 'Pretendard', sans-serif; background-color: var(--bg); color: var(--text); padding-bottom: 70px; margin: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
      
      .date-scroller { display: flex; overflow-x: auto; padding: 12px 10px; gap: 10px; background: white; border-bottom: 1px solid #eee; -webkit-overflow-scrolling: touch; position: sticky; top: 0; z-index: 1000; }
      .date-scroller::-webkit-scrollbar { display: none; }
      .date-btn { min-width: 50px; height: 60px; background: #f1f3f5; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; flex-shrink: 0; border: none; cursor: pointer; }
      .date-btn.active { background: var(--primary); color: white; }
      .date-btn .dow { font-size: 10px; opacity: 0.8; }
      .date-btn .day { font-size: 16px; font-weight: 700; }

      .filter-bar { background: white; padding: 10px 15px; display: flex; gap: 8px; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
      .filter-bar select { border-radius: 8px; font-size: 13px; border: 1px solid #ddd; height: 36px; flex: 1; }

      .product-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 12px; }
      .p-card { background: white; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; height: 100%; box-shadow: 0 2px 6px rgba(0,0,0,0.04); position: relative; }
      .p-img-box { position: relative; width: 100%; aspect-ratio: 1/1; background: #fff; display: flex; align-items: center; justify-content: center; }
      .p-img { width: 100%; height: 100%; object-fit: contain; }
      .p-info { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; }
      .p-brand { font-size: 11px; color: var(--primary); font-weight: 700; margin-bottom: 3px; }
      .p-name { font-size: 13px; font-weight: 600; line-height: 1.35; color: #333; min-height: 35px; max-height: 35px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; margin-bottom: 10px; }
      .p-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: center; padding-top: 8px; border-top: 1px solid #f1f1f1; }
      .p-loc { font-size: 10px; background: #f1f3f5; padding: 2px 5px; border-radius: 4px; color: #666; font-weight: 600; }
      .b-badge { position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,0.65); color: white; padding: 2px 6px; border-radius: 5px; font-size: 9px; font-weight: 600; z-index: 5; }

      .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; height: 55px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 2000; }
      .nav-btn { flex: 1; border: none; background: none; color: #adb5bd; display: flex; flex-direction: column; align-items: center; justify-content: center; outline: none; transition: 0.2s; position: relative; }
      .nav-btn.active { color: var(--primary); background: #f8faff; border-top: 2px solid var(--primary); font-weight: 800; }
      .nav-btn span { font-size: 11px; font-weight: 500; margin-top: 2px; }
      .badge-cnt { position: absolute; top: 5px; right: 25%; background: #ef4444; color: white; border-radius: 10px; padding: 1px 5px; font-size: 9px; font-weight: bold; display: none; }

      .modal-content { border-radius: 20px; border: none; overflow: hidden; }
      .modal-body { padding: 0; padding-bottom: 20px; }
      .modal-img-wrap { width: 100%; background: #fff; border-bottom: 1px solid #eee; position: relative; cursor: pointer; }
      #m-img { width: 100%; height: auto; max-height: 45vh; object-fit: contain; }
      .m-product-info-top { font-size: 12px; color: #888; margin: 15px 20px 4px; line-height: 1.2; }
      .m-product-info-top b { color: #222; font-weight: 800; }
      .m-product-title { font-size: 14px; font-weight: 700; color: #111; margin: 0 20px 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: calc(100% - 40px); }
      
      .modal-main-padding { padding: 0 20px; }
      .loc-input-group { background: #f8f9fa; padding: 12px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eee; }
      .loc-input-group label { font-size: 11px; font-weight: 700; color: var(--primary); display: block; margin-bottom: 5px; }
      .loc-input-group input { width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 8px; font-size: 14px; outline: none; background: white; }

      .table-full-container { margin: 0; padding: 0; width: 100%; overflow-x: auto; }
      .st-table { font-size: 10px !important; width: 100% !important; margin: 0 !important; border-collapse: collapse; table-layout: fixed; border: none !important; }
      .st-table th, .st-table td { border: 1px solid #eee; padding: 10px 2px; text-align: center; vertical-align: middle; overflow: hidden; }
      .col-color { width: 19vw !important; white-space: nowrap !important; font-size: 9px !important; font-weight: 600; background-color: #fcfcfc; }
      .st-table input { width: 100%; border: none; text-align: center; font-size: 11px; outline: none; background: transparent; padding: 0; }
      .st-table th { background: #f8f9fa; font-weight: 700; color: #666; }
      .cell-clickable { color: #333; font-weight: 400; cursor: pointer; text-decoration: none; }
      .cell-clickable:active { background: #eef2ff; font-weight: 700; }

      .outfit-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; padding: 10px 20px; }
      .outfit-box { background: #f8f9fa; border: 1px solid #eee; border-radius: 6px; padding: 8px 4px; text-align: center; cursor: pointer; transition: 0.1s; }
      .outfit-box:active { background: #e9ecef; }
      .outfit-host { font-size: 11px; color: #888; margin-bottom: 2px; }
      .outfit-size { font-size: 12px; font-weight: 700; color: #333; }
      
      .rental-history-item { padding: 8px 20px; border-bottom: 1px solid #f8f9fa; display: flex; justify-content: space-between; font-size: 12px; color: #555; }
      .rh-name { font-weight: 600; color: #333; }
      .rh-info { color: #888; font-size: 11px; }

      .input-form-box { background: #f1f3f5; padding: 15px; margin: 10px 20px; border-radius: 12px; display: none; box-sizing: border-box; }
      .form-row { display: flex; gap: 8px; margin-bottom: 8px; width: 100%; }
      .form-row input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; outline: none; box-sizing: border-box; }
      .of-name { flex: 4; } 
      .of-size { flex: 6; }
      .form-label { font-size: 11px; color: #666; font-weight: 600; margin-bottom: 8px; display: block; }

      #loading-overlay { position: fixed; inset: 0; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
      .spinner { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .time-label { font-size: 16px; font-weight: 800; margin: 5px 12px 10px; display: flex; align-items: center; gap: 8px; }
      .time-label::after { content: ""; flex-grow: 1; height: 1px; background: #ddd; }
      
      .load-more-btn { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #eee; background: white; border-radius: 8px; font-size: 13px; font-weight: 700; color: #555; }

      .rental-tabs { display: flex; padding: 10px 15px; gap: 10px; background: white; border-bottom: 1px solid #eee; }
      .rental-tab-btn { flex: 1; padding: 8px; border: 1px solid #eee; background: #f8f9fa; border-radius: 8px; font-size: 13px; font-weight: 600; color: #666; }
      .rental-tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
      
      .cart-item { background: white; border-radius: 10px; padding: 12px; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border: 1px solid #f1f1f1; }
      .cart-info div { font-size: 13px; font-weight: 700; color: #333; margin-bottom: 2px; }
      .cart-info small { font-size: 11px; color: #888; }
      .cart-actions { display: flex; align-items: center; gap: 8px; }
      .btn-del { width: 24px; height: 24px; border-radius: 50%; background: #fee2e2; color: #ef4444; border: none; font-size: 12px; display: flex; align-items: center; justify-content: center; }

      .full-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: 700; margin-top: 10px; }
      .search-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; margin-bottom: 10px; outline: none; }
      
      .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 12px; z-index: 3000; opacity: 0; transition: 0.3s; pointer-events: none; }
      .toast.show { opacity: 1; }
      
      .section-header { font-size: 13px; font-weight: 700; color: #333; margin: 25px 20px 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 5px; }

      .handling-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 0 20px; }
      .h-card { background: white; border: 1px solid #eee; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative; }
      .h-img-wrap { width: 100%; aspect-ratio: 1/1; background: #f8f9fa; display: flex; align-items: center; justify-content: center; overflow: hidden; }
      .h-img { width: 100%; height: 100%; object-fit: contain; }
      .h-desc { padding: 10px; font-size: 12px; color: #444; line-height: 1.4; word-break: break-all; min-height: 40px; }
      .h-del-btn { position: absolute; top: 5px; right: 5px; background: rgba(255,255,255,0.9); border: 1px solid #ddd; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; display: flex; align-items: center; justify-content: center; color: #666; cursor: pointer; z-index: 5; }
      
      .handling-form-box { background: #f1f3f5; padding: 15px; margin: 10px 20px; border-radius: 12px; display: none; }
      .handling-form-box label { font-size: 11px; font-weight: 700; color: var(--primary); display: block; margin-bottom: 5px; }
      .handling-form-box textarea { width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 8px; font-size: 13px; height: 60px; margin-bottom: 8px; }
      .btn-mini { font-size: 11px; padding: 2px 8px; background: #4361ee; color: white; border: none; border-radius: 4px; cursor: pointer; }
      
      .modal-footer { padding-bottom: 30px; border: 0; }
    </style>
  </head>
  <body>
    <div id="loading-overlay"><div class="spinner"></div><div class="small">데이터 가져오는 중...</div></div>
    
    <div id="page-schedule">
      <div class="date-scroller" id="dateScroller"></div>
      <div id="scheduleContainer"></div>
    </div>

    <div id="page-inventory" style="display:none;">
      <div class="filter-bar">
        <select id="brandSel" class="form-select form-select-sm" onchange="resetFilter()"></select>
        <select id="cateSel" class="form-select form-select-sm" onchange="resetFilter()"></select>
      </div>
      <div id="inventoryContainer" class="product-grid"></div>
      <div id="loadMoreContainer" style="padding: 0 12px 20px;"></div>
    </div>

    <div id="page-rental" style="display:none; padding: 0 0 15px 0;">
      <div class="rental-tabs" style="position:sticky; top:0; z-index:100; background:white;">
        <button class="rental-tab-btn active" onclick="switchRentalMode('rent')" id="rt-rent">대여하기</button>
        <button class="rental-tab-btn" onclick="switchRentalMode('return')" id="rt-return">반납하기</button>
      </div>

      <div id="mode-rent" style="padding: 0 15px;">
        <h6 style="margin: 15px 0 10px; font-weight: 700; font-size: 14px;">대여 카트 <span id="cart-cnt" style="color:var(--primary)">0</span></h6>
        <div id="cart-list" style="min-height: 100px; max-height: 50vh; overflow-y: auto;">
            <div class="text-center py-4 small text-muted">재고관리 탭에서 수량을 클릭하여<br>카트에 담아주세요.</div>
        </div>
        <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
            <label style="font-size: 12px; font-weight: 700; margin-bottom: 5px; display: block;">대여자 이름</label>
            <input type="text" id="renter-name" class="search-input" placeholder="이름을 입력하세요">
            <button class="full-btn" onclick="submitRental()">대여 처리 완료</button>
        </div>
      </div>

      <div id="mode-return" style="display:none; padding: 0 15px;">
        <div style="margin-top: 15px;">
            <input type="text" id="return-search" class="search-input" placeholder="대여자 이름 또는 상품명 검색" onkeydown="if(event.key==='Enter') searchReturns()">
            <button class="btn btn-sm btn-secondary w-100 mb-3" onclick="searchReturns()">조회</button>
        </div>
        <div id="return-list" style="max-height: 50vh; overflow-y: auto;">
            <div class="text-center py-4 small text-muted">반납할 대여 건을 검색하세요.</div>
        </div>
        <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
             <label style="font-size: 12px; font-weight: 700; margin-bottom: 5px; display: block;">반납 처리자</label>
             <input type="text" id="returner-name" class="search-input" placeholder="확인자 이름">
             <button class="full-btn" onclick="submitReturn()">반납 처리 완료</button>
        </div>
      </div>
    </div>

    <nav class="bottom-nav">
      <button class="nav-btn active" id="nav-sch" onclick="switchTab('schedule')"><span>편성표</span></button>
      <button class="nav-btn" id="nav-inv" onclick="switchTab('inventory')"><span>재고관리</span></button>
      <button class="nav-btn" id="nav-rent" onclick="switchTab('rental')"><span>대여/반납</span><span id="global-badge" class="badge-cnt">0</span></button>
    </nav>
    
    <div class="modal fade" id="itemModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down"><div class="modal-content"><div class="modal-body">
      <div class="modal-img-wrap mb-2" onclick="openLotteMall()"><img id="m-img" src=""><button type="button" class="btn-close" data-bs-dismiss="modal" style="position:absolute; top:15px; right:15px; background:white; border-radius:50%; padding:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1);"></button></div>
      <div class="m-product-info-top" id="m-info-top"></div>
      <div class="m-product-title" id="m-title"></div>
      
      <div class="modal-main-padding">
          <ul class="nav nav-pills nav-fill mb-3 bg-light p-1 rounded-pill">
              <li class="nav-item"><button class="nav-link active rounded-pill py-2 small" id="t-view" onclick="toggleModalView('view')">재고 현황</button></li>
              <li class="nav-item"><button class="nav-link rounded-pill py-2 small" id="t-outfit" onclick="toggleModalView('outfit')">착장 내역</button></li>
              <li class="nav-item"><button class="nav-link rounded-pill py-2 small" id="t-add" onclick="toggleModalView('add')">입고 등록</button></li>
          </ul>
      </div>

      <div id="v-view" style="display:block;">
         <div id="v-stock-table" class="table-full-container"></div>
         
         <div id="rental-wrapper" style="display:none;">
             <div class="section-header">현재 대여 현황</div>
             <div id="rental-container"></div>
         </div>

         <div class="section-header">
             핸들링 정보 
             <button class="btn-mini" onclick="toggleHandlingForm()">+ 등록</button>
         </div>
         
         <div id="handling-form" class="handling-form-box">
             <label>이미지 등록 (JPG)</label>
             <div class="d-flex align-items-center gap-2 mb-2">
                 <input type="file" id="h-file-input" accept="image/jpeg, image/jpg" class="form-control form-control-sm" onchange="previewImage(this)">
             </div>
             <img id="h-img-preview" src="" style="display:none; width:100px; height:100px; object-fit:cover; border-radius:6px; margin-bottom:8px;">
             
             <label>설명 내용</label>
             <textarea id="h-desc-input" placeholder="설명 입력"></textarea>
             
             <div class="d-flex gap-2">
                 <button class="btn btn-sm btn-secondary flex-grow-1" style="background:#adb5bd; border:none;" onclick="resetHandlingForm()">취소</button>
                 <button class="btn btn-sm btn-secondary flex-grow-1" id="btn-h-save" onclick="saveHandling()">저장</button>
             </div>
         </div>

         <div id="handling-container" class="handling-grid"></div>
      </div>

      <div id="v-outfit" style="display:none;">
          <div id="outfit-container" class="outfit-grid"></div>
          <div class="d-grid px-3 mt-3">
              <button class="btn btn-outline-primary btn-sm" onclick="toggleOutfitForm()">+ 착장내역 등록</button>
          </div>
          <div id="outfit-form" class="input-form-box">
              <span class="form-label">진행자 / 게스트 등록 (최대 2명)</span>
              <div class="form-row"><input type="text" class="of-name" placeholder="이름"><input type="text" class="of-size" placeholder="사이즈"></div>
              <div class="form-row"><input type="text" class="of-name" placeholder="이름"><input type="text" class="of-size" placeholder="사이즈"></div>
              <button class="btn btn-sm btn-primary w-100 mt-2" onclick="saveOutfit()">저장</button>
          </div>
      </div>

      <div id="v-add" style="display:none;">
         <div class="modal-main-padding"><div class="loc-input-group"><label>입고 위치 입력 (G열 저장)</label><input type="text" id="in-location" placeholder="예: 행거A1-1"></div></div>
         <div id="add-table-container" class="table-full-container"></div>
         <div class="modal-main-padding"><div class="d-flex gap-2 mt-3 mb-4"><button class="btn btn-sm btn-outline-secondary w-100 py-2" onclick="addRow()">+ 색상</button><button class="btn btn-sm btn-outline-secondary w-100 py-2" onclick="addCol()">+ 사이즈</button></div></div>
      </div>
      
    </div><div class="modal-footer border-0"><button type="button" class="btn btn-primary w-100 py-2" id="btn-save" style="display:none;" onclick="saveData()">저장</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_URL = "https://script.google.com/macros/s/AKfycbzpAjxDWvpV8BLsMiezsBSTINg6tIe18OyJkz4pDuChnToiVajjt5BmZWAuVrnl7Eh1/exec";
      let curItem = null, allItems = [], selDate = null, modalObj = null;
      let allStockMap = {}, allRentals = [], allOutfits = [], allHandlings = {};
      let invLimit = 30, filteredItems = [], cart = []; 

      window.onpopstate = function() {
        if (document.getElementById('itemModal').classList.contains('show')) { modalObj.hide(); }
        else if (document.getElementById('page-inventory').style.display !== 'none') { switchTabUI('schedule'); }
      };

      window.onload = function() { fetchData("getInitialData"); };

      function fetchData(action, params = "") {
        const btn = document.getElementById("btn-save");
        
        // 데이터 읽기: 깃허브 JSON 우선 사용
        if (action === "getInitialData") {
            fetch(`data.json?v=${new Date().getTime()}`)
              .then(res => res.json())
              .then(data => handleResponse(data, action))
              .catch(err => {
                  console.error("GitHub JSON 로드 실패, GAS API 시도:", err);
                  fetch(`${API_URL}?action=${action}${params}&v=${new Date().getTime()}`)
                      .then(res => res.json())
                      .then(data => handleResponse(data, action))
                      .catch(err => handleError(err));
              });
            return;
        }

        // 데이터 쓰기: 구글 API 사용
        fetch(`${API_URL}?action=${action}${params}&v=${new Date().getTime()}`)
          .then(res => res.json())
          .then(data => handleResponse(data, action))
          .catch(err => handleError(err));
      }

      function fetchPost(action, payload) {
        fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ action: action, payload: payload }),
            headers: { "Content-Type": "text/plain;charset=utf-8" }
        })
        .then(res => res.json())
        .then(data => handleResponse(data, action))
        .catch(err => handleError(err));
      }

      function handleResponse(data, action) {
        const btn = document.getElementById("btn-save");
        const btnH = document.getElementById("btn-h-save");

        if (action == "getInitialData") onDataLoad(data);
        else if (action == "saveInventoryData") {
            alert(data); 
            updateLocalStock(curItem.code, document.getElementById("in-location").value, null);
            document.getElementById("in-location").value = ""; 
            document.querySelectorAll("#add-table input[type='number']").forEach(i => i.value = ""); 
            btn.disabled = false; btn.innerText = "저장";
            const stock = allStockMap[curItem.code] || [];
            renderStock(stock);
            toggleModalView('view');
        } else if (action == "processRental") {
            alert(data.message);
            cart = []; renderCart(); 
            document.getElementById("renter-name").value = "";
            const rentalBtn = document.querySelector("#mode-rent .full-btn");
            if(rentalBtn) { rentalBtn.disabled = false; rentalBtn.innerText = "대여 처리 완료"; }
            fetchData("getInitialData");
        } else if (action == "processReturn") {
            alert(data.message);
            document.getElementById('return-list').innerHTML = ''; 
            document.getElementById('return-search').value = '';
            fetchData("getInitialData");
        } else if (action == "saveOutfitsBulk") {
            alert(data.message);
            fetchData("getInitialData");
            toggleOutfitForm();
        } else if (action == "saveHandlingInfo") {
            alert(data.message);
            btnH.disabled = false; btnH.innerText = "저장";
            if(data.success) {
                if (!allHandlings[curItem.code]) allHandlings[curItem.code] = [];
                allHandlings[curItem.code].push({ img: data.newUrl, desc: document.getElementById("h-desc-input").value });
                renderHandling(curItem.code);
                resetHandlingForm(); 
                toggleHandlingForm(); 
            }
        } else if (action == "deleteHandlingInfo") {
            alert(data.message);
            if (data.success) {
                fetchData("getInitialData");
            }
        }
      }

      function handleError(err) {
        const btn = document.getElementById("btn-save");
        const btnH = document.getElementById("btn-h-save");
        if(btn) { btn.disabled = false; btn.innerText = "저장"; }
        if(btnH) { btnH.disabled = false; btnH.innerText = "저장"; }
        console.error(err);
        alert("오류 발생: " + err);
      }

      function onDataLoad(data) {
        allItems = data.items || []; allStockMap = data.stockMap || {}; allRentals = data.rentals || []; 
        allOutfits = data.outfits || []; allHandlings = data.handlings || {};
        
        modalObj = new bootstrap.Modal(document.getElementById('itemModal'));
        const b = document.getElementById("brandSel"), c = document.getElementById("cateSel");
        b.innerHTML = '<option value="All">전체 브랜드</option>'; c.innerHTML = '<option value="All">전체 카테고리</option>';
        data.brands.forEach(v => b.add(new Option(v, v))); data.categories.forEach(v => c.add(new Option(v, v)));
        
        const scroller = document.getElementById("dateScroller"); 
        scroller.innerHTML = "";
        
        if(data.dates.length > 0) {
          selDate = data.dates[0];
          data.dates.forEach(d => {
            const dateObj = new Date(d); const btn = document.createElement("div");
            btn.className = `date-btn ${d === selDate ? 'active' : ''}`;
            btn.innerHTML = `<span class="dow">${"일월화수목금토"[dateObj.getDay()]}</span><span class="day">${dateObj.getDate()}</span>`;
            btn.onclick = () => { document.querySelectorAll('.date-btn').forEach(el => el.classList.remove('active')); btn.classList.add('active'); selDate = d; renderSchedule(); };
            scroller.appendChild(btn);
          });
        }
        
        // [추가된 부분] 깃허브 강제 업데이트 버튼
        const upBtn = document.createElement("div");
        upBtn.className = "date-btn";
        upBtn.style.backgroundColor = "#212529";
        upBtn.style.color = "white";
        upBtn.innerHTML = `<span class="material-icons-round" style="font-size:20px; margin-bottom:2px;">sync</span><span class="dow" style="font-size:9px;">UP</span>`;
        upBtn.onclick = requestGithubUpdate;
        scroller.appendChild(upBtn);

        renderSchedule(); 
        
        if(curItem && document.getElementById('itemModal').classList.contains('show')) {
            renderHandling(curItem.code);
            renderOutfits(curItem.code);
        }
        
        document.getElementById('loading-overlay').style.display = 'none';
        window.history.pushState({page: 'main'}, '');
      }

      function generateLotteImage(code) {
        let s = String(code);
        if (s.length < 8) return ""; 
        let p1 = s.substring(6, 8); 
        let p2 = s.substring(4, 6); 
        let p3 = s.substring(2, 4); 
        return `https://image2.lotteimall.com/goods/${p1}/${p2}/${p3}/${s}_L.jpg`;
      }

      function openModal(item) {
        curItem = item;
        document.getElementById("m-info-top").innerHTML = `<b>${item.brand}</b> | ${item.code} | <b>${item.location || '-'}</b>`;
        document.getElementById("m-title").innerText = item.name.replace(/(\r\n|\n|\r)/gm, " ");
        document.getElementById("m-img").src = item.image ? item.image : generateLotteImage(item.code);
        document.getElementById("in-location").value = (item.location === "-" ? "" : item.location);
        toggleModalView('view');
        
        const stock = allStockMap[item.code] || [];
        renderStock(stock);
        renderOutfits(item.code);
        renderCurrentRentals(item.code);
        renderHandling(item.code);

        const colors = (item.colors || "기본").split(","), sizes = (item.sizes || "Free").split(",");
        let ah = `<table class="st-table" id="add-table"><thead><tr><th class="col-color">색상</th>${sizes.map(s=>`<th><input type="text" value="${s.trim()}" style="font-weight:bold;"></th>`).join("")}</tr></thead><tbody>`;
        colors.forEach(c => { ah += `<tr><td class="col-color">${c.trim()}</td>` + sizes.map(()=>`<td><input type="number"></td>`).join("") + "</tr>"; });
        document.getElementById("add-table-container").innerHTML = ah + "</tbody></table>";
        
        window.history.pushState({page: 'modal'}, '');
        modalObj.show();
      }

      function previewImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                const imgEl = document.getElementById('h-img-preview');
                imgEl.src = e.target.result;
                imgEl.style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
      }

      function toggleHandlingForm() {
        const form = document.getElementById("handling-form");
        form.style.display = form.style.display === "block" ? "none" : "block";
      }
      
      function resetHandlingForm() {
        document.getElementById("h-file-input").value = "";
        document.getElementById("h-desc-input").value = "";
        document.getElementById("h-img-preview").src = "";
        document.getElementById("h-img-preview").style.display = "none";
      }

      function deleteHandling(img, desc) {
        if (!confirm("정말 삭제하시겠습니까?")) return;
        const payload = { code: curItem.code, img: img, desc: desc };
        fetchPost("deleteHandlingInfo", payload);
      }

      function renderHandling(code) {
        const list = allHandlings[code];
        const container = document.getElementById("handling-container");
        
        if (!list || list.length === 0) {
            container.innerHTML = '<div class="text-muted small text-center w-100 py-3" style="grid-column:span 2;">등록된 정보가 없습니다.</div>';
            return;
        }

        let html = '';
        list.forEach(item => {
            const safeDesc = (item.desc || "").replace(/"/g, "&quot;").replace(/'/g, "\\'");
            const safeImg = (item.img || "").replace(/"/g, "&quot;").replace(/'/g, "\\'");
            
            html += `
            <div class="h-card">
                <div class="h-del-btn" onclick="deleteHandling('${safeImg}', '${safeDesc}')">✕</div>
                ${item.img ? `<div class="h-img-wrap"><img src="${item.img}" class="h-img" loading="lazy"></div>` : ''}
                <div class="h-desc">${item.desc || ''}</div>
            </div>`;
        });
        container.innerHTML = html;
      }

      function saveHandling() {
        const fileInput = document.getElementById("h-file-input");
        const desc = document.getElementById("h-desc-input").value;
        const file = fileInput.files[0];
        
        const btn = document.getElementById("btn-h-save");
        btn.disabled = true; btn.innerText = "저장 중...";

        const payload = { code: curItem.code, desc: desc, imageBase64: null, fileName: null, mimeType: null };

        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const dataUrl = canvas.toDataURL("image/jpeg", 0.6);
                    const base64 = dataUrl.split(",")[1];
                    
                    payload.imageBase64 = base64;
                    payload.fileName = "resized_" + file.name;
                    payload.mimeType = "image/jpeg";
                    
                    fetchPost("saveHandlingInfo", payload);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        } else {
            fetchPost("saveHandlingInfo", payload);
        }
      }

      function renderCurrentRentals(code) {
        const wrapper = document.getElementById("rental-wrapper");
        const container = document.getElementById("rental-container");
        const list = allRentals.filter(r => r.code == code);

        if (list.length === 0) {
            wrapper.style.display = 'none'; 
            return;
        }

        wrapper.style.display = 'block'; 
        let html = '';
        list.forEach(r => {
            html += `
            <div class="rental-history-item">
                <span class="rh-name">${r.renter}</span>
                <span class="rh-info">${r.color}/${r.size} (${r.qty}) | ${r.date.substring(5,10)}</span>
            </div>`;
        });
        container.innerHTML = html;
      }

      function addToCart(code, name, color, size, currentQty) {
        if(currentQty <= 0) return showToast("재고가 없습니다.");
        const exist = cart.find(i => i.code === code && i.color === color && i.size === size);
        if(exist) { if(exist.qty < currentQty) { exist.qty++; showToast("카트 수량 추가됨"); } else showToast("재고 수량 초과"); } 
        else { cart.push({code, name, color, size, qty: 1, max: currentQty}); showToast("대여 카트에 담김"); }
        renderCart();
      }
      function renderCart() {
        const list = document.getElementById("cart-list"); const cnt = document.getElementById("cart-cnt"); const badge = document.getElementById("global-badge");
        const total = cart.reduce((a,b) => a+b.qty, 0); cnt.innerText = total; badge.innerText = total; badge.style.display = total > 0 ? "block" : "none";
        if(cart.length === 0) { list.innerHTML = '<div class="text-center py-4 small text-muted">카트가 비어있습니다.</div>'; return; }
        let html = ''; cart.forEach((item, idx) => { html += `<div class="cart-item"><div class="cart-info"><div>${item.name}</div><small>${item.color} / ${item.size}</small></div><div class="cart-actions"><span style="font-size:12px; font-weight:bold;">${item.qty}개</span><button class="btn-del" onclick="removeFromCart(${idx})">✕</button></div></div>`; }); list.innerHTML = html;
      }
      function removeFromCart(idx) { cart.splice(idx, 1); renderCart(); }
      
      function submitRental() {
        if(cart.length === 0) return alert("카트에 상품 없음");
        const name = document.getElementById("renter-name").value.trim();
        if(!name) return alert("이름 입력");
        if(!confirm("대여 처리하시겠습니까?")) return;
        
        const btn = document.querySelector("#mode-rent .full-btn");
        if(btn) { btn.disabled = true; btn.innerText = "처리 중..."; }

        const payload = { items: cart, renter: name };
        fetchData("processRental", `&payload=${encodeURIComponent(JSON.stringify(payload))}`);
      }

      function searchReturns() {
        const q = document.getElementById("return-search").value.trim(); const list = document.getElementById("return-list");
        if(!q) return alert("검색어 입력");
        const res = allRentals.filter(r => r.renter.includes(q) || r.name.includes(q));
        if(res.length === 0) { list.innerHTML = '<div class="text-center py-4 small text-muted">검색 결과 없음</div>'; return; }
        let html = ''; res.forEach((r, idx) => { html += `<div class="cart-item"><div class="d-flex align-items-center gap-2"><input type="checkbox" class="return-chk" data-idx="${idx}" style="width:20px; height:20px;"><div class="cart-info"><div>${r.name}</div><small>${r.renter} | ${r.color}/${r.size} (${r.qty}) | ${r.date.substring(5,10)}</small></div></div></div>`; });
        list.innerHTML = html; list.dataset.searchResults = JSON.stringify(res);
      }
      function submitReturn() {
        const list = document.getElementById("return-list"); const checkboxes = list.querySelectorAll(".return-chk:checked");
        if(checkboxes.length === 0) return alert("항목 선택");
        const name = document.getElementById("returner-name").value.trim();
        if(!name) return alert("이름 입력");
        const searchResults = JSON.parse(list.dataset.searchResults || "[]"); const itemsToReturn = [];
        checkboxes.forEach(chk => { itemsToReturn.push(searchResults[parseInt(chk.dataset.idx)]); });
        if(!confirm("반납 처리하시겠습니까?")) return;
        const payload = { items: itemsToReturn, returner: name }; fetchData("processReturn", `&payload=${encodeURIComponent(JSON.stringify(payload))}`);
      }
      function switchTab(t) { const modalEl = document.getElementById('itemModal'); if (modalEl.classList.contains('show') && modalObj) { modalObj.hide(); } window.history.pushState({page: t}, ''); switchTabUI(t); }
      function switchTabUI(t) {
        document.getElementById('page-schedule').style.display = t === 'schedule' ? 'block' : 'none';
        document.getElementById('page-inventory').style.display = t === 'inventory' ? 'block' : 'none';
        document.getElementById('page-rental').style.display = t === 'rental' ? 'block' : 'none';
        document.getElementById('nav-sch').classList.toggle('active', t === 'schedule');
        document.getElementById('nav-inv').classList.toggle('active', t === 'inventory');
        document.getElementById('nav-rent').classList.toggle('active', t === 'rental');
        if (t === 'inventory' && document.getElementById("inventoryContainer").innerHTML === "") { resetFilter(); }
        if (t === 'rental') { if (cart.length > 0) switchRentalMode('rent'); renderCart(); }
      }
      function switchRentalMode(mode) {
        document.getElementById('mode-rent').style.display = mode === 'rent' ? 'block' : 'none';
        document.getElementById('mode-return').style.display = mode === 'return' ? 'block' : 'none';
        document.getElementById('rt-rent').classList.toggle('active', mode === 'rent');
        document.getElementById('rt-return').classList.toggle('active', mode === 'return');
      }
      function toggleOutfitForm() { const form = document.getElementById("outfit-form"); form.style.display = form.style.display === "block" ? "none" : "block"; }
      
      function renderOutfits(code) {
        const container = document.getElementById("outfit-container"); const list = allOutfits.filter(o => o.code == code);
        if (list.length === 0) { container.innerHTML = '<div class="text-muted small text-center w-100" style="grid-column: span 4;">등록된 정보가 없습니다.</div>'; return; }
        
        let html = ''; 
        list.forEach(o => { 
            const safeHost = o.host.replace(/'/g, "\\'");
            const safeSize = o.size.replace(/'/g, "\\'");
            html += `<div class="outfit-box" onclick="editOutfit('${safeHost}', '${safeSize}')"><div class="outfit-host">${o.host}</div><div class="outfit-size">${o.size}</div></div>`; 
        }); 
        container.innerHTML = html;
      }

      function editOutfit(host, oldSize) {
        const newSize = prompt(`${host}님의 사이즈를 수정합니다.`, oldSize);
        if (newSize === null) return; 
        if (newSize === oldSize || newSize.trim() === "") return; 

        const payload = [{ code: curItem.code, host: host, size: newSize.trim() }];
        fetchData("saveOutfitsBulk", `&payload=${encodeURIComponent(JSON.stringify(payload))}`);
      }

      function saveOutfit() {
        const names = document.querySelectorAll('.of-name'); const sizes = document.querySelectorAll('.of-size'); const payload = [];
        names.forEach((nameIn, i) => { if(nameIn.value.trim() && sizes[i].value.trim()) { payload.push({ code: curItem.code, host: nameIn.value.trim(), size: sizes[i].value.trim() }); } });
        if (payload.length === 0) return alert("입력 필요");
        fetchData("saveOutfitsBulk", `&payload=${encodeURIComponent(JSON.stringify(payload))}`);
        names.forEach(i => i.value = ""); sizes.forEach(i => i.value = "");
      }
      
      function renderStock(stock) {
        const container = document.getElementById("v-stock-table");
        if(!stock || !stock.length) { container.innerHTML = "<div class='text-center py-4 small'>재고 없음</div>"; return; }
        
        const sizes = sortSizes([...new Set(stock.map(s => s.size))]); 
        const colors = [...new Set(stock.map(s => s.color))].sort();
        
        let h = `<table class="st-table"><thead><tr><th class="col-color">색상</th>${sizes.map(s=>`<th>${s}</th>`).join("")}</tr></thead><tbody>`;
        colors.forEach(c => { h += `<tr><td class="col-color">${c}</td>` + sizes.map(s => { const q = stock.filter(x => x.color === c && x.size === s).reduce((a, b) => a + Number(b.qty), 0); const clickAttr = q > 0 ? `class="cell-clickable" onclick="addToCart('${curItem.code}', '${curItem.name.replace(/'/g, "")}', '${c}', '${s}', ${q})"` : ''; return `<td ${clickAttr}>${q || 0}</td>`; }).join("") + "</tr>"; }); container.innerHTML = h + "</tbody></table>";
      }

      function sortSizes(sizes) {
        const order = ["44", "55", "66", "77", "88", "XS", "S", "M", "L", "XL", "2XL", "3XL", "85", "90", "95", "100", "105", "110", "115"];
        return sizes.sort((a, b) => {
            const idxA = order.indexOf(a.toUpperCase());
            const idxB = order.indexOf(b.toUpperCase());
            if (idxA !== -1 && idxB !== -1) return idxA - idxB;
            if (idxA !== -1) return -1;
            if (idxB !== -1) return 1;
            return a.localeCompare(b);
        });
      }

      function saveData() {
        const table = document.getElementById("add-table"), headers = Array.from(table.rows[0].cells).slice(1).map(c => c.querySelector("input").value.trim());
        const loc = document.getElementById("in-location").value.trim(), matrix = [];
        for(let i=1; i<table.rows.length; i++) {
          const color = table.rows[i].cells[0].innerText.trim(); if(!color) continue;
          headers.forEach((size, idx) => { const qty = table.rows[i].cells[idx+1].querySelector("input").value; if(qty && Number(qty) > 0) matrix.push({ color, size, qty: Number(qty) }); });
        }
        if(matrix.length === 0) return alert("수량 입력");
        const btn = document.getElementById("btn-save"); btn.disabled = true; btn.innerText = "저장 중...";
        const combined = curItem.brand + " " + curItem.name;
        const payload = { code: curItem.code, combinedName: combined, name: curItem.name, matrix: matrix, location: loc };
        fetchData("saveInventoryData", `&payload=${encodeURIComponent(JSON.stringify(payload))}`);
      }
      function updateLocalStock(code, newLoc, paramsString) { try { if(paramsString){ const urlParams = new URLSearchParams(paramsString); const payload = JSON.parse(urlParams.get("payload")); if(!allStockMap[code]) allStockMap[code] = []; payload.matrix.forEach(m => { allStockMap[code].push({ size: m.size, color: m.color, qty: m.qty }); }); } if(newLoc) { curItem.location = newLoc; document.getElementById("m-info-top").innerHTML = `<b>${curItem.brand}</b> | ${curItem.code} | <b>${newLoc}</b>`; } } catch(e) { console.error(e); } }
      function resetFilter() { invLimit = 30; document.getElementById("inventoryContainer").innerHTML = ""; const b = document.getElementById("brandSel").value, c = document.getElementById("cateSel").value; filteredItems = allItems.filter(i => (b==='All' || i.brand === b) && (c==='All' || i.category === c)); renderInventoryChunk(); }
      function renderInventoryChunk() { const container = document.getElementById("inventoryContainer"); const btnContainer = document.getElementById("loadMoreContainer"); if (filteredItems.length === 0) { container.innerHTML = '<div class="text-center py-5 small w-100">상품 없음</div>'; btnContainer.innerHTML = ""; return; } const currentCount = container.children.length; const nextBatch = filteredItems.slice(currentCount, invLimit); nextBatch.forEach(i => container.appendChild(createCard(i))); if (filteredItems.length > invLimit) { btnContainer.innerHTML = `<button class="load-more-btn" onclick="loadMore()">더 보기 (${filteredItems.length - invLimit}개 남음)</button>`; } else { btnContainer.innerHTML = ""; } }
      function loadMore() { invLimit += 30; renderInventoryChunk(); }
      function renderSchedule() { const container = document.getElementById("scheduleContainer"); container.innerHTML = ""; const filtered = allItems.filter(i => i.dateKey === selDate).sort((a,b) => parseTime(a.date) - parseTime(b.date)); if (!filtered.length) { container.innerHTML = '<div class="text-center py-5 small">편성 없음</div>'; return; } const groups = {}; filtered.forEach(i => { const t = i.date && i.date.match(/\d{1,2}:\d{1,2}/) ? i.date.match(/\d{1,2}:\d{1,2}/)[0] : "시간미정"; if(!groups[t]) groups[t] = []; groups[t].push(i); }); Object.keys(groups).forEach(t => { const g = document.createElement("div"); g.innerHTML = `<div class="time-label">${t}</div>`; const grid = document.createElement("div"); grid.className = "product-grid"; groups[t].forEach(item => grid.appendChild(createCard(item))); g.appendChild(grid); container.appendChild(g); }); }
      function createCard(item) { const div = document.createElement("div"); div.className = "p-card"; div.onclick = () => openModal(item); const timeMatch = item.date && item.date.match(/\d{1,2}:\d{1,2}/); const imgSrc = item.image ? item.image : generateLotteImage(item.code); div.innerHTML = `<div class="p-img-box">${timeMatch ? `<div class="b-badge">${timeMatch[0]}</div>` : ''}<img src="${imgSrc}" class="p-img" loading="lazy"></div><div class="p-info"><div class="p-brand">${item.brand || ""}</div><div class="p-name">${item.name || ""}</div><div class="p-footer"><span class="p-loc">${item.location || "-"}</span></div></div>`; return div; }
      function toggleModalView(v) { document.getElementById('v-view').style.display = v === 'view' ? 'block' : 'none'; document.getElementById('v-outfit').style.display = v === 'outfit' ? 'block' : 'none'; document.getElementById('v-add').style.display = v === 'add' ? 'block' : 'none'; document.getElementById('btn-save').style.display = v === 'add' ? 'block' : 'none'; document.getElementById('t-view').classList.toggle('active', v === 'view'); document.getElementById('t-outfit').classList.toggle('active', v === 'outfit'); document.getElementById('t-add').classList.toggle('active', v === 'add'); }
      function openLotteMall() { if(!curItem || !curItem.code) return; window.open("https://www.lotteimall.com/goods/viewGoodsDetail.lotte?goods_no=" + curItem.code, '_blank'); }
      function parseTime(s) { if(!s) return 9999; const m = s.match(/(\d{1,2}):(\d{1,2})/); if(!m) return 9999; let h = parseInt(m[1]), min = parseInt(m[2]); if(s.includes("오후") && h < 12) h += 12; if(s.includes("오전") && h === 12) h = 0; return h * 60 + min; }
      function addRow() { const table = document.getElementById("add-table"), row = table.insertRow(); row.innerHTML = `<td class="col-color"><input type="text" placeholder="색상"></td>` + `<td><input type="number"></td>`.repeat(table.rows[0].cells.length - 1); }
      function addCol() { const table = document.getElementById("add-table"), th = document.createElement("th"); th.innerHTML = `<input type="text" placeholder="사이즈">`; table.rows[0].appendChild(th); for(let i=1; i<table.rows.length; i++) { table.rows[i].insertCell().innerHTML = `<input type="number">`; } }
      function showToast(msg) { const t = document.createElement('div'); t.className = 'toast show'; t.innerText = msg; document.body.appendChild(t); setTimeout(() => t.remove(), 2000); }

      function requestGithubUpdate() {
        if (!confirm("현재 데이터를 깃허브 웹사이트에 반영하시겠습니까?\n(약 1~2분 소요됩니다)")) return;
        document.getElementById('loading-overlay').style.display = 'flex';
        fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ action: "forceUpdate", payload: {} }),
            headers: { "Content-Type": "text/plain;charset=utf-8" }
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById('loading-overlay').style.display = 'none';
            if (data.success) alert("✅ 요청 성공: 깃허브 업데이트가 시작되었습니다.\n잠시 후 웹사이트에 반영됩니다.");
            else alert("❌ 실패: " + (data.message || "알 수 없는 오류"));
        })
        .catch(err => {
            document.getElementById('loading-overlay').style.display = 'none';
            alert("통신 오류 발생: " + err);
        });
      }
    </script>
  </body>
</html>
