<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>LOTTE WM Dashboard Professional</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root { --primary: #4361ee; --primary-soft: #eef2ff; --bg: #f8f9fa; --text: #1a1a1a; --nav-height: 56px; }
        
        body { 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background-color: var(--bg); color: var(--text); margin: 0; padding-top: var(--nav-height); letter-spacing: -0.5px; 
        }

        /* [핵심 수정] 상단 네비게이션 및 중앙 레이아웃 (데스크톱 13% 여백) */
        .top-nav { position: fixed; top: 0; left: 0; right: 0; height: var(--nav-height); background: white; box-shadow: 0 1px 10px rgba(0,0,0,0.05); z-index: 2000; display: flex; align-items: center; }
        
        /* 기본 모바일 설정 (여백 없음) */
        .nav-container, .main-content { 
            width: 100%; 
            margin: 0 auto; 
            padding: 0 15px;
        }

        /* 데스크톱 설정 (양옆 13% 여백 반영 - 가로폭 74%) */
        @media (min-width: 992px) {
            .nav-container, .main-content { 
                width: 74%; 
                max-width: 1800px; 
            }
        }

        .nav-logo { font-weight: 800; font-size: 1.2rem; color: var(--primary); text-decoration: none; cursor: pointer; }
        .nav-menu { display: flex; gap: 5px; }
        .nav-item { border: none; background: none; padding: 6px 15px; border-radius: 8px; font-size: 14px; font-weight: 600; color: #666; transition: 0.2s; }
        .nav-item.active { background: var(--primary-soft); color: var(--primary); }

        .main-content { padding-top: 15px; padding-bottom: 50px; }
        .page-section { display: none; }
        .page-section.active { display: block; }

        /* [메인 목록] 4열 그리드 */
        .product-grid { display: grid; gap: 12px; grid-template-columns: repeat(2, 1fr); }
        @media (min-width: 768px) { .product-grid { grid-template-columns: repeat(4, 1fr); } }

        .p-card { background: white; border-radius: 12px; overflow: hidden; border: 1px solid #eee; transition: 0.2s; cursor: pointer; height: 100%; display: flex; flex-direction: column; }
        .p-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.08); }
        .p-img-box { aspect-ratio: 1/1.1; background: #fff; position: relative; }
        .p-img { width: 100%; height: 100%; object-fit: contain; }
        .p-info { padding: 12px; flex-grow: 1; }
        .p-brand { font-size: 11px; color: var(--primary); font-weight: 800; margin-bottom: 2px; }
        .p-name { font-size: 13px; font-weight: 600; line-height: 1.3; height: 34px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }

        /* [상세 페이지] 대시보드 레이아웃 최적화 */
        .dash-layout { display: grid; grid-template-columns: 1fr; gap: 12px; align-items: start; }
        @media (min-width: 992px) { .dash-layout { grid-template-columns: 420px 1fr; } }

        .dash-card { background: white; border-radius: 15px; padding: 15px; border: 1px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.02); margin-bottom: 12px; }

        /* [사진2 반영] 목록으로 버튼 라인 삭제 및 상단 여백 제거 */
        #page-detail { margin-top: 0; }

        /* 이미지+정보 통합 헤더 (상품명 블랙) */
        .integrated-section { background: white; border-radius: 15px; border: 1px solid #eee; overflow: hidden; }
        .img-header-overlay { padding: 20px 20px 10px 20px; background: white; }
        .det-full-title { font-size: 24px; font-weight: 800; line-height: 1.2; margin-bottom: 8px; letter-spacing: -1px; }
        .det-full-title .brand-span { color: var(--primary); margin-right: 8px; }
        .det-full-title .name-span { color: #000; } /* 상품명 블랙 확정 */
        .det-sub-info { display: flex; gap: 8px; align-items: center; }
        .badge-item { padding: 4px 10px; border-radius: 5px; font-size: 12px; font-weight: 700; border: 1px solid #dee2e6; }
        .badge-code { background: #f8f9fa; color: #495057; }
        .badge-loc { background: var(--primary); color: white; border: none; }
        .det-main-img { width: 100%; padding: 15px; display: block; object-fit: contain; background: white; }

        /* [재고 표] RAW 순서 및 블랙 폰트 */
        .compact-table .st-table { width: 100%; font-size: 14px; border-collapse: separate; border-spacing: 0; border: 1px solid #eee; border-radius: 10px; overflow: hidden; table-layout: fixed; }
        .compact-table th { background: #f8f9fa; padding: 10px 4px; font-weight: 700; border-bottom: 1px solid #eee; text-align: center; color: #333; }
        .compact-table td { padding: 14px 4px; border-bottom: 1px solid #eee; text-align: center; color: #000 !important; font-weight: 800; }
        .compact-table td:first-child { width: 110px; background: #fcfcfc; font-weight: 700; }

        /* [착장 정보] 4열 배치 */
        .outfit-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        @media (min-width: 576px) { .outfit-grid { grid-template-columns: repeat(4, 1fr); } }
        .outfit-item { background: white; border: 1px solid #eee; border-radius: 10px; padding: 12px 5px; text-align: center; }
        .outfit-host-name { font-size: 13px; font-weight: 700; color: #000; margin-bottom: 2px; display: block; }
        .outfit-size-val { font-size: 18px; font-weight: 800; color: #000; display: block; }

        /* 편성표 날짜 & 시간 */
        .date-scroller { display: flex; overflow-x: auto; padding: 10px 0; gap: 8px; position: sticky; top: var(--nav-height); background: var(--bg); z-index: 1000; }
        .date-btn { min-width: 55px; height: 65px; background: white; border-radius: 10px; border: 1px solid #eee; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.15s; }
        .date-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .date-btn .dow { font-size: 11px; margin-bottom: 2px; }
        .date-btn .day { font-size: 17px; font-weight: 800; }

        .time-divider { display: flex; align-items: center; gap: 10px; margin: 20px 0 12px; font-weight: 800; color: var(--primary); font-size: 15px; }
        .time-divider::after { content: ""; flex-grow: 1; height: 1px; background: #e0e0e0; }

        /* 로딩 화면 */
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { width: 35px; height: 35px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading-overlay"><div class="spinner"></div><div class="mt-2 fw-bold small">잠시만 기달려주세용!!...</div></div>

    <nav class="top-nav">
        <div class="nav-container">
            <a href="javascript:void(0)" class="nav-logo" onclick="handleNavClick('schedule')">LOTTE PB실 재고</a>
            <div class="nav-menu">
                <button class="nav-item active" id="nav-sch" onclick="handleNavClick('schedule')">편성표</button>
                <button class="nav-item" id="nav-inv" onclick="handleNavClick('inventory')">재고관리</button>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <!-- 1. 편성표 페이지 -->
        <section id="page-schedule" class="page-section active">
            <div id="dateScroller" class="date-scroller"></div>
            <div id="scheduleContainer" class="mt-1"></div>
        </section>

        <!-- 2. 재고관리 페이지 -->
        <section id="page-inventory" class="page-section">
            <div class="card border-0 shadow-sm p-2 mb-2 rounded-3">
                <div class="row g-2">
                    <div class="col-6"><select id="brandSel" class="form-select form-select-sm bg-light" onchange="resetFilter()"></select></div>
                    <div class="col-6"><select id="cateSel" class="form-select form-select-sm bg-light" onchange="resetFilter()"></select></div>
                    <div class="col-12"><input type="text" id="invSearch" class="form-control form-control-sm bg-light" placeholder="상품명, 브랜드, 코드 검색" onkeyup="resetFilter()"></div>
                </div>
            </div>
            <div id="inventoryContainer" class="product-grid"></div>
            <div id="loadMoreContainer" class="text-center mt-3"></div>
        </section>

        <!-- 3. 상세 정보 페이지 -->
        <section id="page-detail" class="page-section">
            <!-- [사진2 반영] 목록으로 버튼 및 공백 삭제됨. 바로 내용 시작 -->
            <div class="dash-layout">
                <!-- 왼쪽: 정보 통합 섹션 -->
                <div class="dash-left">
                    <div class="integrated-section">
                        <div class="img-header-overlay">
                            <h1 class="det-full-title">
                                <span id="det-brand" class="brand-span">BRAND</span>
                                <span id="det-name" class="name-span">PRODUCT NAME</span>
                            </h1>
                            <div class="det-sub-info">
                                <span id="det-code" class="badge-item badge-code">CODE</span>
                                <span id="det-loc" class="badge-item badge-loc">LOCATION</span>
                            </div>
                        </div>
                        <img id="det-img" src="" alt="상품이미지" class="det-main-img">
                    </div>
                </div>

                <!-- 오른쪽: 데이터 영역 -->
                <div class="dash-right">
                    <div class="dash-card">
                        <div class="dash-title"><i class="material-icons-round">inventory_2</i> 실시간 재고 현황</div>
                        <div id="v-stock-table" class="compact-table"></div>
                        <div id="v-rental-wrapper" class="mt-3 p-2 bg-light rounded-3" style="display:none; font-size:12px;">
                            <div class="fw-bold mb-1">현재 대여 중</div>
                            <div id="v-rental-list" class="d-flex flex-wrap gap-2"></div>
                        </div>
                    </div>

                    <div class="dash-bottom-grid">
                        <div class="dash-card">
                            <div class="dash-title"><i class="material-icons-round">face</i> 착장 정보</div>
                            <div id="v-outfit-container" class="outfit-grid"></div>
                        </div>
                        <div id="handling-card" class="dash-card">
                            <div class="dash-title"><i class="material-icons-round">info</i> 핸들링 가이드</div>
                            <div id="v-handling-container" class="row g-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwGGJsflqUqpv4ep9NU8BV_zXpqTDzrcgGER6vKzKOeOBNIVeZFyAJdbSl3pWscSyTA/exec";
        
        let allItems = [], allStockMap = {}, allRentals = [], allOutfits = [], allHandlings = {};
        let selDate = null, invLimit = 40, filteredItems = [];

        window.onload = function() {
            history.replaceState({page: 'schedule'}, '');
            fetchData("getInitialData");
        };

        window.onpopstate = function(event) {
            if (event.state && event.state.page) {
                if (event.state.page === 'detail' && event.state.item) renderDetailUI(event.state.item);
                else renderPageUI(event.state.page);
            }
        };

        function fetchData(action, params = "") {
            document.getElementById('loading-overlay').style.display = 'flex';
            fetch(API_URL + "?action=" + action + params)
                .then(res => res.json())
                .then(data => { if (action === "getInitialData") onDataLoad(data); })
                .catch(err => { console.error(err); alert("데이터 연결 실패"); })
                .finally(() => { document.getElementById('loading-overlay').style.display = 'none'; });
        }

        function onDataLoad(data) {
            allItems = data.items || []; allStockMap = data.stockMap || {}; allRentals = data.rentals || [];
            allOutfits = data.outfits || []; allHandlings = data.handlings || {};
            const b = document.getElementById("brandSel"), c = document.getElementById("cateSel");
            b.innerHTML = '<option value="All">브랜드 전체</option>'; c.innerHTML = '<option value="All">카테고리 전체</option>';
            data.brands.forEach(v => b.add(new Option(v, v))); data.categories.forEach(v => c.add(new Option(v, v)));
            const scroller = document.getElementById("dateScroller"); scroller.innerHTML = "";
            if(data.dates.length > 0) {
                if(!selDate) selDate = data.dates[0];
                data.dates.forEach(d => {
                    const dateObj = new Date(d); const btn = document.createElement("div");
                    btn.className = `date-btn ${d === selDate ? 'active' : ''}`;
                    btn.innerHTML = `<span class="dow">${"일월화수목금토"[dateObj.getDay()]}</span><span class="day">${dateObj.getDate()}</span>`;
                    btn.onclick = () => { selDate = d; renderSchedule(); };
                    scroller.appendChild(btn);
                });
            }
            renderPageUI(history.state ? history.state.page : 'schedule');
        }

        function handleNavClick(page) { history.pushState({page: page}, '', '#' + page); renderPageUI(page); }

        function renderPageUI(t) {
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById('page-'+t).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
            const nid = t==='schedule'?'nav-sch':'nav-inv';
            if(document.getElementById(nid)) document.getElementById(nid).classList.add('active');
            if(t === 'schedule') renderSchedule();
            if(t === 'inventory' && !document.getElementById("inventoryContainer").children.length) resetFilter();
            window.scrollTo(0,0);
        }

        function renderSchedule() {
            const container = document.getElementById("scheduleContainer"); container.innerHTML = "";
            document.querySelectorAll('.date-btn').forEach(btn => {
                const dayVal = parseInt(btn.querySelector('.day').innerText);
                const selObj = new Date(selDate);
                if (dayVal === selObj.getDate()) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            const filtered = allItems.filter(i => !i.isMaster && i.dateKey === selDate).sort((a,b)=>parseTime(a.date)-parseTime(b.date));
            if(!filtered.length) { container.innerHTML = "<div class='text-center py-5 text-muted'>편성 일정이 없습니다.</div>"; return; }
            const groups = {};
            filtered.forEach(item => {
                const tm = item.date ? item.date.match(/(\d{1,2}:\d{1,2})/) : null;
                const key = tm ? tm[1] : "시간미정";
                if (!groups[key]) groups[key] = [];
                groups[key].push(item);
            });
            Object.keys(groups).sort((a,b)=>parseTime(a)-parseTime(b)).forEach(time => {
                const div = document.createElement("div"); div.className = "time-divider";
                div.innerHTML = `<span class="material-icons-round fs-5">schedule</span> ${time} 방송`;
                container.appendChild(div);
                const grid = document.createElement("div"); grid.className = "product-grid";
                groups[time].forEach(item => grid.appendChild(createCard(item)));
                container.appendChild(grid);
            });
        }

        function createCard(item) {
            const div = document.createElement("div"); div.className = "p-card"; 
            div.onclick = () => { history.pushState({page: 'detail', item: item}, '', '#detail'); renderDetailUI(item); };
            div.innerHTML = `<div class="p-img-box"><img src="${item.image || ''}" class="p-img"></div><div class="p-info"><div class="p-brand">${item.brand}</div><div class="p-name">${item.name}</div></div>`;
            return div;
        }

        function renderDetailUI(item) {
            curItem = item;
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById('page-detail').classList.add('active');
            document.getElementById("det-brand").innerText = item.brand;
            document.getElementById("det-name").innerText = item.name;
            document.getElementById("det-code").innerText = item.code;
            document.getElementById("det-loc").innerText = item.location || "미지정";
            document.getElementById("det-img").src = item.image || "";
            renderStock(allStockMap[item.code] || []);
            renderOutfits(item.code); renderHandling(item.code); renderCurrentRentals(item.code);
            window.scrollTo(0,0);
        }

        function renderStock(stock) {
            const container = document.getElementById("v-stock-table");
            if(!stock.length) { container.innerHTML = "<div class='py-4 text-center text-muted small'>데이터 없음</div>"; return; }
            const sizes = []; const colors = [];
            stock.forEach(i => { if(i.size && !sizes.includes(i.size)) sizes.push(i.size); if(i.color && !colors.includes(i.color)) colors.push(i.color); });
            let h = `<table class="st-table"><thead><tr><th>색상</th>${sizes.map(s=>`<th>${s}</th>`).join("")}</tr></thead><tbody>`;
            colors.forEach(c => {
                h += `<tr><td class="bg-light fw-bold">${c}</td>` + sizes.map(s => {
                    const q = stock.filter(x => x.color === c && x.size === s).reduce((a, b) => a + Number(b.qty), 0);
                    return `<td>${q || 0}</td>`;
                }).join("") + "</tr>";
            });
            container.innerHTML = h + "</tbody></table>";
        }

        function renderOutfits(code) {
            const container = document.getElementById("v-outfit-container");
            const list = allOutfits.filter(o => o.code == code);
            container.innerHTML = list.length ? list.map(o => `<div class="outfit-item"><span class="outfit-host-name">${o.host}</span><span class="outfit-size-val">${o.size}</span></div>`).join("") : '<div class="col-12 text-center py-3 text-muted small">정보 없음</div>';
        }

        function renderHandling(code) {
            const container = document.getElementById("v-handling-container");
            const card = document.getElementById("handling-card");
            const list = allHandlings[code];
            if (!list || !list.length) { card.style.display = "none"; return; }
            card.style.display = "block";
            container.innerHTML = list.map(h => `<div class="col-12 bg-light rounded p-2 small fw-bold text-center border">${h.img ? `<img src="${h.img}" class="img-fluid mb-2 rounded shadow-sm">` : ''}<div>${h.desc}</div></div>`).join("");
        }

        function renderCurrentRentals(code) {
            const list = allRentals.filter(r => r.code == code), wrapper = document.getElementById("v-rental-wrapper");
            if (!list.length) { wrapper.style.display = "none"; return; }
            wrapper.style.display = "block";
            document.getElementById("v-rental-list").innerHTML = list.map(r => `<span class="badge bg-white text-dark border fw-normal p-2">${r.renter} (${r.color}/${r.size})</span>`).join("");
        }

        function resetFilter() {
            const b = document.getElementById("brandSel").value; const c = document.getElementById("cateSel").value; const q = document.getElementById("invSearch").value.toLowerCase();
            filteredItems = allItems.filter(i => i.isMaster && (b === 'All' || i.brand === b) && (c === 'All' || i.category === c) && (i.name.toLowerCase().includes(q) || i.brand.toLowerCase().includes(q) || i.code.toLowerCase().includes(q)));
            document.getElementById("inventoryContainer").innerHTML = ""; renderInventoryChunk();
        }

        function renderInventoryChunk() {
            const container = document.getElementById("inventoryContainer"), current = container.children.length;
            const next = filteredItems.slice(current, current + invLimit);
            next.forEach(i => container.appendChild(createCard(i)));
            document.getElementById("loadMoreContainer").innerHTML = filteredItems.length > container.children.length ? `<button class="btn btn-outline-primary rounded-pill px-4 btn-sm" onclick="renderInventoryChunk()">더 보기</button>` : "";
        }

        function parseTime(s) { if(!s) return 9999; const m = s.match(/(\d{1,2}):(\d{1,2})/); return m ? parseInt(m[1])*60+parseInt(m[2]) : 9999; }
    </script>
</body>
</html>
