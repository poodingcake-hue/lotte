<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>LOTTE PB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --primary-soft: #eef2ff;
            --bg: #f8f9fa;
            --text: #1a1a1a;
            --nav-height: 64px;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding-top: var(--nav-height);
            letter-spacing: -0.5px;
        }

        /* 헤더 디자인: 로고(좌) / 메뉴(우) */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background: white;
            box-shadow: 0 1px 10px rgba(0, 0, 0, 0.05);
            z-index: 2000;
            display: flex;
            align-items: center;
            border: none;
        }

        .nav-container,
        .main-content {
            width: 100%;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* 데스크톱 양옆 13% 여백 반영 */
        @media (min-width: 992px) {

            .nav-container,
            .main-content {
                width: 74%;
                max-width: 1800px;
            }
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-logo {
            font-weight: 800;
            font-size: 1.5rem;
            color: var(--primary);
            text-decoration: none;
            cursor: pointer;
        }

        .nav-menu {
            display: flex;
            gap: 5px;
        }

        .nav-item {
            border: none;
            background: none;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            color: #444;
            transition: 0.2s;
            white-space: nowrap;
        }

        @media (max-width: 576px) {
            .nav-logo {
                font-size: 1.1rem;
            }

            .nav-item {
                padding: 6px 8px;
                font-size: 13px;
            }

            .nav-container {
                padding: 0 8px;
            }

            :root {
                --nav-height: 56px;
            }
        }

        .nav-item.active {
            background: var(--primary-soft);
            color: var(--primary);
        }

        .main-content {
            padding-top: 15px;
            padding-bottom: 50px;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        /* 대시보드 레이아웃 */
        .dash-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            align-items: start;
        }

        @media (min-width: 992px) {
            .dash-layout {
                grid-template-columns: 420px 1fr;
            }
        }

        .dash-card {
            background: white;
            border-radius: 12px;
            padding: 12px;
            border: 1px solid #eee;
            margin-bottom: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.02);
        }

        .dash-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid #f8f9fa;
        }

        .dash-title {
            font-size: 13px;
            font-weight: 800;
            color: #444;
        }

        /* 이미지+정보 통합 헤더 */
        .integrated-section {
            background: white;
            border-radius: 12px;
            border: 1px solid #eee;
            overflow: hidden;
        }

        .img-header-overlay {
            padding: 15px;
            background: white;
        }

        .det-product-name {
            font-size: 19px;
            font-weight: 800;
            color: #000;
            line-height: 1.2;
            margin-bottom: 6px;
        }

        .det-sub-info {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .badge-item {
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: 700;
            border: 1px solid #dee2e6;
        }

        .badge-code {
            background: #f8f9fa;
            color: #495057;
        }

        .badge-loc {
            background: var(--primary);
            color: white;
            border: none;
        }

        .det-main-img {
            width: 80%;
            margin: 0 auto;
            padding: 5px;
            display: block;
            object-fit: contain;
            cursor: pointer;
        }

        /* 재고 표 */
        .compact-table {
            width: 100%;
            max-width: 100%;
        }

        /* 입고 등록 모드에서만 적용될 가로 스크롤 스타일 */
        .compact-table.scrollable-mode {
            display: block;
            /* 컨테이너 성격 부여 */
            width: 100%;
            max-width: 100%;
            /* 부모 카드를 넘지 않도록 제한 */
            overflow-x: auto;
            /* 내부 스크롤 활성화 */
            -webkit-overflow-scrolling: touch;
        }

        .compact-table .st-table {
            width: 100%;
            font-size: 12.5px;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
        }

        .compact-table.scrollable-mode .st-table {
            width: max-content;
            /* 내용물에 맞춰 최대한 확장 */
            min-width: 100%;
            /* 하지만 부모보다는 작지 않게 */
        }

        .compact-table th {
            background: #f8f9fa;
            padding: 6px 4px;
            font-weight: 800;
            color: #333;
            border-bottom: 1px solid #eee;
            text-align: center;
        }

        .compact-table td {
            padding: 8px 4px;
            border-bottom: 1px solid #eee;
            text-align: center;
            color: #000 !important;
            font-weight: 700;
        }

        .compact-table td:first-child {
            width: 100px;
            background: #fcfcfc;
            font-weight: 700;
        }

        /* 공통 정보 카드 (착장/대여) */
        .info-card-grid {
            display: grid;
            gap: 6px;
            grid-template-columns: repeat(2, 1fr);
        }

        /* 리스트형 테이블 스타일 추가 */
        .list-table {
            width: 100%;
            font-size: 13px;
            border-collapse: collapse;
        }

        .list-table th {
            padding: 10px 5px;
            border-bottom: 1px solid #eee;
            color: #666;
            font-weight: 700;
            text-align: center;
        }

        .list-table td {
            padding: 10px 4px;
            border-bottom: 1px solid #f8f9fa;
            text-align: center;
            vertical-align: middle;
            font-size: 12px;
        }

        @media (max-width: 576px) {
            .list-table {
                font-size: 11px;
            }

            .list-table th,
            .list-table td {
                padding: 8px 2px;
            }

            .qty-badge {
                font-size: 11px;
            }

            .date-text {
                font-size: 10px;
                display: block;
                margin-bottom: 2px;
            }
        }

        .list-product-info {
            text-align: left !important;
            line-height: 1.3;
            word-break: keep-all;
            /* 단어 단위로 끊기 */
            white-space: normal;
        }

        .list-product-name {
            font-weight: 800;
            display: block;
        }

        .list-product-desc {
            font-size: 11px;
            color: #666;
            white-space: nowrap;
            /* 색상/사이즈는 한 줄에 표시 시도 */
        }

        .qty-badge {
            color: #d63384;
            font-weight: 800;
        }

        .date-text {
            color: #aaa;
            font-size: 11px;
        }

        @media (min-width: 576px) {
            .info-card-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .info-item-card {
            background: white;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 8px 4px;
            text-align: center;
            position: relative;
        }

        .info-card-top {
            font-size: 13px;
            font-weight: 700;
            color: #000;
            margin-bottom: 1px;
            display: block;
        }

        .info-card-bottom {
            font-size: 17px;
            font-weight: 800;
            color: #000;
            display: block;
        }

        .delete-btn {
            position: absolute;
            top: 2px;
            right: 5px;
            color: #ddd;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
        }

        .delete-btn:hover {
            color: #ff4d4f;
        }

        /* + 버튼 스타일 */
        .btn-plus {
            background: var(--primary);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 6px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        /* 상품 목록 (4열) */
        .product-grid {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(2, 1fr);
        }

        @media (min-width: 768px) {
            .product-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .p-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #eee;
            cursor: pointer;
            height: 100%;
            display: flex;
            flex-direction: column;
            transition: 0.15s;
        }

        .p-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
        }

        .p-img-box {
            aspect-ratio: 1/1.1;
            background: #fff;
        }

        .p-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .p-info {
            padding: 10px;
            flex-grow: 1;
        }

        .p-brand {
            font-size: 11px;
            color: var(--primary);
            font-weight: 800;
            margin-bottom: 2px;
        }

        .p-name {
            font-size: 12.5px;
            font-weight: 600;
            line-height: 1.3;
            height: 32px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        #loading-overlay {
            position: fixed;
            inset: 0;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .date-scroller {
            display: flex;
            overflow-x: auto;
            padding: 8px 0;
            gap: 8px;
            position: sticky;
            top: var(--nav-height);
            background: var(--bg);
            z-index: 1000;
        }

        .date-btn {
            min-width: 60px;
            height: 68px;
            background: white;
            border-radius: 12px;
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.15s;
        }

        .date-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* 커스텀 모달 스타일 */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            backdrop-filter: blur(8px);
        }

        .custom-modal {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            width: 92%;
            max-width: 440px;
            padding: 32px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: modalScaleUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes modalScaleUp {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 24px;
            color: #000;
            letter-spacing: -1px;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 16px;
            border: 1px solid #f1f3f5;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
            /* grid 아이템 넘침 방지 */
        }

        .input-label {
            font-size: 11px;
            font-weight: 800;
            color: var(--primary);
            margin-left: 2px;
            text-transform: uppercase;
        }

        .modal-input {
            width: 100%;
            border: 1px solid #e9ecef;
            background: white;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 14px;
            font-weight: 700;
            outline: none;
            transition: 0.3s;
            box-sizing: border-box;
        }

        .modal-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-soft);
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            margin-top: 28px;
        }

        .m-btn {
            flex: 1;
            padding: 14px;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 800;
            border: none;
            transition: 0.3s;
            cursor: pointer;
        }

        .m-btn-cancel {
            background: #f1f3f5;
            color: #495057;
        }

        .m-btn-confirm {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        .m-btn:hover {
            transform: translateY(-2px);
            filter: brightness(1.05);
        }

        .m-btn-confirm:hover {
            box-shadow: 0 6px 16px rgba(67, 97, 238, 0.4);
        }

        .m-btn:active {
            transform: translateY(0);
        }

        /* 특이사항 섹션 스타일 */
        .notes-section {
            margin-top: 10px;
            background: white;
            border-radius: 12px;
            border: 1px solid #eee;
            padding: 15px;
        }

        .notes-title {
            font-size: 13px;
            font-weight: 800;
            color: #444;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .notes-area {
            width: 100%;
            min-height: 42px;
            height: auto;
            border: 1px solid #f1f3f5;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 14px;
            font-weight: 600;
            outline: none;
            transition: 0.1s;
            background: #f8f9fa;
            resize: none;
            overflow: hidden;
        }

        .notes-area:focus {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-soft);
        }

        .notes-save-btn {
            padding: 5px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 800;
            cursor: pointer;
            transition: 0.2s;
        }

        .notes-save-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary-soft);
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .cart-item-info {
            font-weight: 700;
        }

        .cart-qty-input {
            width: 45px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            margin-left: 8px;
            font-weight: 800;
        }

        /* 숫자 입력 화살표 제거 */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>

<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="mt-2 fw-bold small">LOTTE PB 데이터 동기화</div>
    </div>

    <nav class="top-nav">
        <div class="nav-container">
            <a href="javascript:void(0)" class="nav-logo" onclick="handleNavClick('schedule')">LOTTE PB</a>
            <div class="nav-menu">
                <button class="nav-item active" id="nav-sch" onclick="handleNavClick('schedule')">편성표</button>
                <button class="nav-item" id="nav-inv" onclick="handleNavClick('inventory')">재고관리</button>
                <button class="nav-item" onclick="forceSync()" title="서버 데이터 강제 동기화"><span class="material-icons-round"
                        style="font-size: 20px; vertical-align: middle;">sync</span></button>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <section id="page-schedule" class="page-section">
            <div id="dateScroller" class="date-scroller"></div>
            <div id="scheduleContainer"></div>
        </section>

        <section id="page-inventory" class="page-section">
            <div class="card border-0 shadow-sm p-2 mb-2 rounded-3">
                <div class="row g-2">
                    <div class="col-6"><select id="brandSel" class="form-select form-select-sm border-0 bg-light"
                            onchange="resetFilter()"></select></div>
                    <div class="col-6"><select id="cateSel" class="form-select form-select-sm border-0 bg-light"
                            onchange="resetFilter()"></select></div>
                    <div class="col-12"><input type="text" id="invSearch"
                            class="form-control form-control-sm border-0 bg-light" placeholder="상품명, 브랜드, 코드 검색"
                            onkeyup="resetFilter()"></div>
                </div>
            </div>
            <div id="inventoryContainer" class="product-grid"></div>
            <div id="loadMoreContainer" class="text-center mt-3"></div>
        </section>

        <section id="page-detail" class="page-section">
            <div class="dash-layout">
                <!-- 이미지 통합 정보 섹션 -->
                <div class="dash-left">
                    <div class="integrated-section">
                        <div class="img-header-overlay">
                            <h1 class="det-product-name" id="det-name">NAME</h1>
                            <div class="det-sub-info">
                                <span id="det-code" class="badge-item badge-code">CODE</span>
                                <span id="det-loc" class="badge-item badge-loc">LOCATION</span>
                            </div>
                        </div>
                        <img id="det-img" src="" alt="상품이미지" class="det-main-img">
                    </div>
                    <!-- 특이사항 입력창 -->
                    <div class="notes-section">
                        <div class="notes-title">
                            상품 특이사항
                            <button class="notes-save-btn" onclick="saveNote()">저장하기</button>
                        </div>
                        <textarea id="det-notes" class="notes-area" placeholder="상품에 대한 특이사항 입력"
                            oninput="autoExpand(this)" spellcheck="false"></textarea>
                    </div>
                </div>
                <!-- 데이터 영역 -->
                <div class="dash-right">
                    <div class="dash-card" id="stock-card">
                        <div class="dash-title-row">
                            <span class="dash-title" id="stock-card-title">실시간 재고 현황</span>
                            <button class="btn-plus" id="stock-toggle-btn" onclick="toggleStockEditMode()">+</button>
                        </div>
                        <div id="v-stock-table" class="compact-table"></div>
                        <div id="stock-edit-actions" style="display:none; margin-top:10px;" class="gap-2">
                            <button class="m-btn m-btn-cancel p-2 small" style="font-size:12px;"
                                onclick="toggleStockEditMode(false)">취소</button>
                            <button class="m-btn m-btn-confirm p-2 small" style="font-size:12px;"
                                onclick="submitStockInPlace()">입고 저장</button>
                        </div>
                    </div>
                    <!-- 착장 정보 섹션 -->
                    <div class="dash-card">
                        <div class="dash-title-row">
                            <span class="dash-title">착장 정보</span>
                            <button class="btn-plus" onclick="addOutfit()">+</button>
                        </div>
                        <div id="v-outfit-container" class="info-card-grid"></div>
                    </div>
                    <!-- 대여 현황 섹션 -->
                    <div class="dash-card">
                        <div class="dash-title-row" id="rental-btn-container">
                            <span class="dash-title">실시간 대여 현황</span>
                        </div>
                        <div id="v-rental-list"></div>
                    </div>
                    <!-- 대여 바구니 섹션 (숫자 클릭 시 노출) -->
                    <div id="v-cart-section" class="dash-card"
                        style="display:none; border: 1.5px solid var(--primary);">
                        <div class="dash-title-row">
                            <span class="dash-title" style="color: var(--primary);">대여 바구니 (등록 대기)</span>
                            <button class="btn-plus" onclick="rentalCart = []; renderCart();"
                                style="background:#999;">×</button>
                        </div>
                        <div id="v-cart-list" class="mb-3"></div>
                        <div class="d-flex gap-2">
                            <input type="text" id="cart-renter" class="form-control form-control-sm border-primary"
                                placeholder="대여자 성함 입력">
                            <button class="btn btn-primary btn-sm fw-bold px-3" style="white-space:nowrap;"
                                onclick="submitRentalCart()">대여 완료</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 착장 등록 모달 -->
    <div id="outfitModal" class="custom-modal-overlay">
        <!-- ... 기존 내용 유지 ... -->
        <div class="custom-modal">
            <h5 class="modal-title">착장 정보 일괄 등록</h5>
            <div id="modal-rows">
                <div class="input-row">
                    <div class="input-group">
                        <span class="input-label">이름 1</span>
                        <input type="text" class="modal-input outfit-name" placeholder="성함">
                    </div>
                    <div class="input-group">
                        <span class="input-label">사이즈 1</span>
                        <input type="text" class="modal-input outfit-size" placeholder="사이즈">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <span class="input-label">이름 2</span>
                        <input type="text" class="modal-input outfit-name" placeholder="성함">
                    </div>
                    <div class="input-group">
                        <span class="input-label">사이즈 2</span>
                        <input type="text" class="modal-input outfit-size" placeholder="사이즈">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <span class="input-label">이름 3</span>
                        <input type="text" class="modal-input outfit-name" placeholder="성함">
                    </div>
                    <div class="input-group">
                        <span class="input-label">사이즈 3</span>
                        <input type="text" class="modal-input outfit-size" placeholder="사이즈">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="m-btn m-btn-cancel" onclick="closeOutfitModal()">취소</button>
                <button class="m-btn m-btn-confirm" onclick="confirmOutfitModal()">등록하기</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * [설정] 깃허브 API 연동
         */
        const GH_CONFIG = {
            user: "poodingcake-hue",
            repo: "lotte",
            // 깃허브 보안 스캐너(Secret Scanning) 감지를 피하기 위해 토큰을 분할하여 런타임에 결합합니다.
            get token() {
                const p1 = "ghp_";
                const p2 = "0CvM1DvDQaP1UAxx";
                const p3 = "JkJ1cPDXqjIzOU4TUtg9";
                return p1 + p2 + p3;
            }
        };

        // 구글 시트 입고 처리를 위한 웹 앱 URL
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwGGJsflqUqpv4ep9NU8BV_zXpqTDzrcgGER6vKzKOeOBNIVeZFyAJdbSl3pWscSyTA/exec";


        let allItems = [], allStockMap = {}, allRentals = [], allOutfits = [], allNotes = [], selDate = null, filteredItems = [], curItem = null;
        let rentalCart = []; // 대여 바구니


        window.onload = () => { initApp(); };
        window.onpopstate = (e) => { if (e.state && e.state.page) renderPageUI(e.state.page, e.state.item); };

        async function initApp() {
            document.getElementById('loading-overlay').style.display = 'flex';
            const ts = new Date().getTime();

            // 깃허브 API로 데이터 불러오는 공통 함수
            async function fetchWithToken(fileName) {
                const url = `https://api.github.com/repos/${GH_CONFIG.user}/${GH_CONFIG.repo}/contents/${fileName}`;
                try {
                    const res = await fetch(url, {
                        headers: { Authorization: `token ${GH_CONFIG.token}` },
                        cache: "no-store" // 캐시 방지 추가
                    });
                    if (res.ok) {
                        const data = await res.json();
                        // 깃허브 base64 데이터의 줄바꿈/공백 제거 후 디코딩 (한글 깨짐 방지 포함)
                        const cleanContent = data.content.replace(/\s/g, "");
                        return JSON.parse(decodeURIComponent(escape(atob(cleanContent))));
                    } else if (res.status !== 404) {
                        console.warn(`${fileName} 로드 실패: ${res.status}`);
                    }
                } catch (e) { console.error(fileName + " 처리 중 오류", e); }
                return [];
            }

            try {
                // 1. 마스터 데이터 (data.json)
                const masterRes = await fetch(`data.json?v=${ts}`);
                const masterData = await masterRes.json();

                // 2. 실시간 대여 정보 (GitHub API)
                allRentals = await fetchWithToken("rentals.json");

                // 3. 실시간 착장 정보 (GitHub API)
                allOutfits = await fetchWithToken("outfits.json");

                // 4. 상품 특이사항 (GitHub API)
                allNotes = await fetchWithToken("notes.json");

                onDataLoad(masterData);
            } catch (err) {
                console.error("동기화 실패:", err);
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        // 깃허브 파일 저장 (SHA 자동갱신 로직 포함)
        async function saveToGitHub(fileName, data) {
            document.getElementById('loading-overlay').style.display = 'flex';
            const url = `https://api.github.com/repos/${GH_CONFIG.user}/${GH_CONFIG.repo}/contents/${fileName}`;
            try {
                // 기존 SHA 가져오기
                const getRes = await fetch(url, { headers: { Authorization: `token ${GH_CONFIG.token}` } });
                const fileInfo = await getRes.json();

                // 파일 업데이트
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                const putRes = await fetch(url, {
                    method: "PUT",
                    headers: { Authorization: `token ${GH_CONFIG.token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ message: `Update ${fileName}`, content: content, sha: fileInfo.sha })
                });

                if (putRes.ok) {
                    // 페이지 전체를 새로고침하는 대신 UI만 즉시 갱신
                    if (curItem) renderDetailUI(curItem);
                }
                else alert("토큰 권한을 확인하세요. (repo 권한 필요)");
            } catch (e) { alert("네트워크 오류"); }
            finally { document.getElementById('loading-overlay').style.display = 'none'; }
        }

        function onDataLoad(data) {
            allItems = data.items || []; allStockMap = data.stockMap || {};
            const b = document.getElementById("brandSel"), c = document.getElementById("cateSel");
            b.innerHTML = '<option value="All">브랜드 전체</option>'; c.innerHTML = '<option value="All">카테고리 전체</option>';
            data.brands.forEach(v => b.add(new Option(v, v))); data.categories.forEach(v => c.add(new Option(v, v)));
            const scroller = document.getElementById("dateScroller"); scroller.innerHTML = "";
            if (data.dates && data.dates.length > 0) {
                if (!selDate) selDate = data.dates[0];
                data.dates.forEach(d => {
                    const dateObj = new Date(d); const btn = document.createElement("div");
                    btn.className = `date-btn ${d === selDate ? 'active' : ''}`;
                    btn.innerHTML = `<span class="dow">${"일월화수목금토"[dateObj.getDay()]}</span><span class="day">${dateObj.getDate()}</span>`;
                    btn.onclick = () => { selDate = d; renderSchedule(); };
                    scroller.appendChild(btn);
                });
            }
            renderPageUI('schedule');
        }

        function handleNavClick(p) { history.pushState({ page: p }, '', '#' + p); renderPageUI(p); }
        function renderPageUI(t, item = null) {
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + t).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.toggle('active', btn.id === (t === 'schedule' ? 'nav-sch' : 'nav-inv')));
            if (t === 'schedule') renderSchedule();
            if (t === 'inventory' && !document.getElementById("inventoryContainer").children.length) resetFilter();
            if (t === 'detail' && item) renderDetailUI(item);
            window.scrollTo(0, 0);
        }

        function renderSchedule() {
            const container = document.getElementById("scheduleContainer"); container.innerHTML = "";
            document.querySelectorAll('.date-btn').forEach(btn => btn.classList.toggle('active', parseInt(btn.querySelector('.day').innerText) === new Date(selDate).getDate()));
            const filtered = allItems.filter(i => !i.isMaster && i.dateKey === selDate).sort((a, b) => parseTime(a.date) - parseTime(b.date));
            const groups = {};
            filtered.forEach(item => {
                const tm = item.date ? item.date.match(/(\d{1,2}:\d{1,2})/) : null;
                const key = tm ? tm[1] : "시간미정";
                if (!groups[key]) groups[key] = []; groups[key].push(item);
            });
            Object.keys(groups).sort((a, b) => parseTime(a) - parseTime(b)).forEach(tm => {
                const div = document.createElement("div"); div.className = "time-divider"; div.innerHTML = `${tm} 방송`;
                container.appendChild(div);
                const grid = document.createElement("div"); grid.className = "product-grid";
                groups[tm].forEach(i => grid.appendChild(createCard(i)));
                container.appendChild(grid);
            });
        }

        function createCard(i) {
            const div = document.createElement("div"); div.className = "p-card";
            div.onclick = () => { history.pushState({ page: 'detail', item: i }, '', '#detail'); renderPageUI('detail', i); };
            div.innerHTML = `<div class="p-img-box"><img src="${getProductImage(i)}" class="p-img"></div><div class="p-info"><div class="p-brand">${i.brand}</div><div class="p-name">${i.name}</div></div>`;
            return div;
        }

        // 이미지 주소가 비어있을 경우 롯데홈쇼핑 웹 이미지를 생성하는 헬퍼 함수
        function getProductImage(i) {
            if (i.image && i.image.trim() !== "") return i.image;
            const code = String(i.code);
            if (code.length < 8) return ""; // 코드가 8자리 미만이면 빈값 반환

            // https://image2.lotteimall.com/goods/'7~8번째'/'5~6번째'/'3~4번째'/'상품코드'_L.jpg
            const p1 = code.substring(6, 8);
            const p2 = code.substring(4, 6);
            const p3 = code.substring(2, 4);
            return `https://image2.lotteimall.com/goods/${p1}/${p2}/${p3}/${code}_L.jpg`;
        }

        function renderDetailUI(i) {
            curItem = i;
            document.getElementById("det-name").innerText = `${i.brand} ${i.name}`;
            document.getElementById("det-code").innerText = i.code;
            document.getElementById("det-loc").innerText = i.location || "-";
            const detImg = document.getElementById("det-img");
            detImg.src = getProductImage(i);
            detImg.onclick = () => window.open(`https://www.lotteimall.com/goods/viewGoodsDetail.lotte?goods_no=${i.code}`, '_blank');

            // 특이사항 불러오기
            const noteObj = allNotes.find(n => n.code == i.code);
            const nArea = document.getElementById("det-notes");
            nArea.value = noteObj ? noteObj.text : "";
            autoExpand(nArea);

            const stock = allStockMap[i.code] || [];
            const sizes = []; const colors = [];
            stock.forEach(s => { if (s.size && !sizes.includes(s.size)) sizes.push(s.size); if (s.color && !colors.includes(s.color)) colors.push(s.color); });
            let h = `<table class="st-table"><thead><tr><th>색상</th>${sizes.map(s => `<th>${s}</th>`).join("")}</tr></thead><tbody>`;
            colors.forEach(c => {
                h += `<tr><td class="bg-light fw-bold">${c}</td>` + sizes.map(s => {
                    const baseQty = stock.filter(x => x.color === c && x.size === s).reduce((a, b) => a + Number(b.qty), 0) || 0;
                    const rentedQty = allRentals.filter(r => r.code == i.code && r.color === c && r.size === s).reduce((a, b) => a + Number(b.qty), 0) || 0;
                    const qty = baseQty - rentedQty;
                    return `<td onclick="addToCart('${i.code}', '${i.brand} ${i.name}', '${c}', '${s}')" style="cursor:pointer; ${qty > 0 ? 'color:var(--primary) !important;' : 'opacity:0.3;'}">${qty}</td>`;
                }).join("") + "</tr>";
            });
            document.getElementById("v-stock-table").innerHTML = h + "</tbody></table>";
            renderCart(); // 카트 상태 초기화


            const outfits = allOutfits.filter(o => o.code == i.code);
            document.getElementById("v-outfit-container").innerHTML = outfits.map(o => `
                <div class="info-item-card">
                    <button class="delete-btn" onclick="deleteEntry('outfit', '${o.code}', '${o.host}')">×</button>
                    <span class="info-card-top">${o.host}</span>
                    <span class="info-card-bottom">${o.size}</span>
                </div>`).join("") || '<div class="col-12 py-1 text-muted small text-center">내역 없음</div>';

            const rentals = allRentals.filter(r => r.code == i.code);
            let rentalHtml = `
                <table class="list-table">
                    <thead>
                        <tr>
                            <th style="width:35px">선택</th>
                            <th style="width:55px">대여자</th>
                            <th>상품 정보</th>
                            <th style="width:35px">수량</th>
                            <th style="width:75px">대여일</th>
                        </tr>
                    </thead>
                    <tbody>`;

            if (rentals.length === 0) {
                rentalHtml += '<tr><td colspan="5" class="py-4 text-muted small">현재 대여 중인 내역이 없습니다.</td></tr>';
            } else {
                rentals.forEach(r => {
                    const d = r.date ? r.date.substring(5, 10) : "-";
                    rentalHtml += `
                        <tr>
                            <td><input type="checkbox" class="rental-check" 
                                data-code="${r.code}" data-renter="${r.renter}" data-color="${r.color}" data-size="${r.size}" data-date="${r.date}"
                                onchange="toggleRentalButtons()" onclick="event.stopPropagation()"></td>
                            <td class="fw-bold">${r.renter}</td>
                            <td class="list-product-info">
                                <span class="list-product-desc">${r.color} / ${r.size}</span>
                            </td>
                            <td><span class="qty-badge">${r.qty}</span></td>
                            <td>
                                <span class="date-text">${d}</span>
                                <button class="delete-btn" style="position:static; margin-left:5px" onclick="deleteEntry('rental', '${r.code}', '${r.renter}', '${r.color}', '${r.size}')">×</button>
                            </td>
                        </tr>`;
                });
            }
            document.getElementById("v-rental-list").innerHTML = rentalHtml + "</tbody></table>";
            toggleRentalButtons();
        }

        function toggleRentalButtons() {
            const checks = document.querySelectorAll('.rental-check:checked');
            const container = document.getElementById('rental-btn-container');
            if (checks.length > 0) {
                container.innerHTML = `<button class="btn btn-primary btn-sm fw-bold px-3 py-1" onclick="returnSelectedRentals()">반납하기</button>`;
            } else {
                container.innerHTML = `<span class="dash-title">실시간 대여 현황</span>`;
            }
        }

        async function returnSelectedRentals() {
            if (!confirm("선택한 항목을 반납 처리하시겠습니까?")) return;
            const checks = document.querySelectorAll('.rental-check:checked');
            checks.forEach(chk => {
                const code = chk.dataset.code;
                const renter = chk.dataset.renter;
                const color = chk.dataset.color;
                const size = chk.dataset.size;
                const date = chk.dataset.date;
                allRentals = allRentals.filter(r => !(r.code == code && r.renter == renter && r.color == color && r.size == size && r.date == date));
            });
            await saveToGitHub("rentals.json", allRentals);
            alert("반납 처리가 완료되었습니다.");
            toggleRentalButtons();
        }

        function autoExpand(el) {
            el.style.height = 'auto';
            el.style.height = (el.scrollHeight) + 'px';
        }

        // 실시간 추가 기능 (+ 버튼 트리거)
        function addOutfit() {
            // 모달 초기화 및 열기
            document.querySelectorAll('.outfit-name, .outfit-size').forEach(el => el.value = '');
            document.getElementById('outfitModal').style.display = 'flex';
        }

        function closeOutfitModal() {
            document.getElementById('outfitModal').style.display = 'none';
        }

        function confirmOutfitModal() {
            const names = document.querySelectorAll('.outfit-name');
            const sizes = document.querySelectorAll('.outfit-size');
            let addedCount = 0;

            for (let i = 0; i < names.length; i++) {
                const h = names[i].value.trim();
                const s = sizes[i].value.trim();
                if (h && s) {
                    allOutfits.push({ code: curItem.code, host: h, size: s });
                    addedCount++;
                }
            }
            if (addedCount > 0) {
                closeOutfitModal();
                saveToGitHub("outfits.json", allOutfits);
            } else {
                alert("최소 한 명 이상의 성함과 사이즈를 입력해주세요.");
            }
        }

        // 특이사항 저장 기능
        async function saveNote() {
            const text = document.getElementById("det-notes").value.trim();
            const idx = allNotes.findIndex(n => n.code == curItem.code);

            if (idx > -1) {
                if (text) allNotes[idx].text = text;
                else allNotes.splice(idx, 1); // 내용이 없으면 제거
            } else if (text) {
                allNotes.push({ code: curItem.code, text: text });
            }

            await saveToGitHub("notes.json", allNotes);
            alert("특이사항이 저장되었습니다.");
        }

        // --- 대여 바구니 관련 함수 ---
        function addToCart(code, name, color, size) {
            const exists = rentalCart.find(x => x.code === code && x.color === color && x.size === size);
            if (exists) { exists.qty++; }
            else { rentalCart.push({ code, name, color, size, qty: 1 }); }
            renderCart();
        }

        function renderCart() {
            const sect = document.getElementById("v-cart-section");
            const list = document.getElementById("v-cart-list");
            if (rentalCart.length === 0) {
                sect.style.display = 'none';
                return;
            }
            sect.style.display = 'block';
            list.innerHTML = rentalCart.map((item, idx) => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        ${item.color} / ${item.size}
                        <input type="number" class="cart-qty-input" value="${item.qty}" min="1" onchange="rentalCart[${idx}].qty = this.value">
                    </div>
                    <button class="delete-btn" style="position:static; color:#666;" onclick="rentalCart.splice(${idx}, 1); renderCart();">×</button>
                </div>
            `).join("");
        }

        async function submitRentalCart() {
            const renter = document.getElementById("cart-renter").value.trim();
            if (!renter) { alert("대여자 성함을 입력해주세요."); return; }
            if (rentalCart.length === 0) return;

            // 기존 리스트에 추가
            rentalCart.forEach(item => {
                allRentals.push({
                    code: item.code,
                    renter: renter,
                    color: item.color,
                    size: item.size,
                    qty: item.qty,
                    date: new Date().toISOString()
                });
            });

            await saveToGitHub("rentals.json", allRentals);
            rentalCart = [];
            document.getElementById("cart-renter").value = "";
            renderCart();
            alert("대여 등록이 완료되었습니다.");
        }

        // --- 입고 관리 (In-place Table Switch) 함수 ---
        let isStockEditMode = false;

        function toggleStockEditMode(forceState) {
            isStockEditMode = (forceState !== undefined) ? forceState : !isStockEditMode;
            const titleRow = document.getElementById("stock-card-title");
            const toggleBtn = document.getElementById("stock-toggle-btn");
            const actions = document.getElementById("stock-edit-actions");
            const tableContainer = document.getElementById("v-stock-table");

            if (isStockEditMode) {
                titleRow.innerText = "신규 입고 등록 모드";
                titleRow.style.color = "var(--primary)";
                toggleBtn.innerText = "×";
                toggleBtn.style.background = "#999";
                actions.style.display = "flex";
                tableContainer.classList.add("scrollable-mode"); // 스크롤 모드 활성화
                renderStockMatrixInPlace();
            } else {
                titleRow.innerText = "실시간 재고 현황";
                titleRow.style.color = "";
                toggleBtn.innerText = "+";
                toggleBtn.style.background = "";
                actions.style.display = "none";
                tableContainer.classList.remove("scrollable-mode"); // 스크롤 모드 해제
                renderDetailUI(curItem); // 다시 뷰 모드로 렌더링
            }
        }

        function renderStockMatrixInPlace() {
            if (!curItem) return;
            const stock = allStockMap[curItem.code] || [];
            let colors = [], sizes = [];

            if (stock.length > 0) {
                stock.forEach(s => {
                    if (s.color && !colors.includes(s.color)) colors.push(s.color);
                    if (s.size && !sizes.includes(s.size)) sizes.push(s.size);
                });
            } else {
                if (curItem.colors) colors = String(curItem.colors).split(',').map(v => v.trim()).filter(v => v);
                if (curItem.sizes) sizes = String(curItem.sizes).split(',').map(v => v.trim()).filter(v => v);
            }

            const container = document.getElementById("v-stock-table");
            let h = `<table class="st-table">
                <thead>
                    <tr>
                        <th style="min-width:70px; width:70px;">색상</th>
                        ${sizes.map(s => `<th style="min-width:45px;">${s}</th>`).join("")}
                        <th style="background:#fff3f8; border: 1px solid #ffccd5; min-width:80px;">
                            <input type="text" id="new-size-name" placeholder="+사이즈" style="width:100%; font-size:10px; border:none; outline:none; background:transparent; text-align:center; font-weight:800;">
                        </th>
                    </tr>
                </thead>
                <tbody>`;

            colors.forEach(c => {
                h += `<tr><td class="bg-light fw-bold" style="font-size:11px;">${c}</td>`;
                sizes.forEach(s => {
                    h += `<td style="padding:0;"><input type="number" class="matrix-input" data-color="${c}" data-size="${s}" style="width:100%; height:32px; border:none; text-align:center; outline:none; font-size:13px; font-weight:800; color:var(--primary);"></td>`;
                });
                h += `<td style="background:#fff9fb; padding:0;"><input type="number" class="matrix-input new-size-qty" data-color="${c}" style="width:100%; height:32px; border:none; text-align:center; outline:none; background:transparent; font-size:13px;"></td></tr>`;
            });

            container.innerHTML = h + "</tbody></table>";
        }

        async function submitStockInPlace() {
            const inputs = document.querySelectorAll(".matrix-input");
            const newSizeName = document.getElementById("new-size-name").value.trim();
            const matrix = [];

            inputs.forEach(input => {
                const qty = parseInt(input.value);
                if (qty && qty !== 0) {
                    let size = input.dataset.size;
                    if (!size) {
                        if (!newSizeName) return;
                        size = newSizeName;
                    }
                    matrix.push({ color: input.dataset.color, size: size, qty: qty });
                }
            });

            if (matrix.length === 0) { alert("입력된 수량이 없습니다."); return; }

            document.getElementById('loading-overlay').style.display = 'flex';
            try {
                const payload = {
                    code: curItem.code,
                    combinedName: `${curItem.brand} ${curItem.name}`,
                    location: curItem.location || "-",
                    matrix: matrix
                };

                const response = await fetch(GAS_WEB_APP_URL, {
                    method: "POST",
                    mode: "cors",
                    headers: {
                        "Content-Type": "text/plain;charset=utf-8"
                    },
                    body: JSON.stringify({ action: "saveInventoryData", payload: payload })
                });

                const resText = await response.text();

                // 메모리 즉시 갱신 (Optimistic Update)
                matrix.forEach(m => {
                    if (!allStockMap[curItem.code]) allStockMap[curItem.code] = [];
                    const stockArr = allStockMap[curItem.code];
                    const existing = stockArr.find(x => x.color === m.color && x.size === m.size);
                    if (existing) {
                        existing.qty = Number(existing.qty) + Number(m.qty);
                    } else {
                        stockArr.push({ color: m.color, size: m.size, qty: m.qty });
                    }
                });

                alert("✅ 입고 등록이 완료되어 재고에 즉시 반영되었습니다.");
                toggleStockEditMode(false); // 입력 모드 종료

                // 화면 즉시 다시 그리기 (네트워크 대기 없이 메모리 값으로 갱신)
                if (curItem) renderDetailUI(curItem);
            } catch (e) {
                console.error("입고 에러 상세:", e);
                alert("네트워크 오류가 발생했습니다. 입고 데이터가 시트에 저장되었는지 확인해 주세요.");
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }


        function addRental() {
            const r = prompt("대여자 성함:"), c = prompt("색상:"), s = prompt("사이즈:"), q = prompt("수량:", "1");
            if (r && c && s) { allRentals.push({ code: curItem.code, renter: r, color: c, size: s, qty: q, date: new Date().toISOString() }); saveToGitHub("rentals.json", allRentals); }
        }
        function deleteEntry(type, code, key, color, size) {
            if (!confirm("삭제하시겠습니까?")) return;
            if (type === 'outfit') allOutfits = allOutfits.filter(o => !(o.code === code && o.host === key));
            else allRentals = allRentals.filter(r => !(r.code === code && r.renter === key && r.color === color && r.size === size));
            saveToGitHub(type === 'outfit' ? "outfits.json" : "rentals.json", type === 'outfit' ? allOutfits : allRentals);
        }

        async function forceSync() {
            if (!confirm("구글 시트의 최신 데이터를 서버로 불러올까요?\n(반영까지 약 1~2분 정도 소요됩니다.)")) return;

            document.getElementById('loading-overlay').style.display = 'flex';
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: "POST",
                    mode: "cors",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ action: "forceUpdate" })
                });

                const result = await response.json();

                if (result.error) {
                    alert("동기화 실패:\n" + result.error);
                } else {
                    await initApp();
                    alert("서버 업데이트가 시작되었습니다.\n1~2분 뒤에 화면을 다시 새로고침 해주세요.");
                }
            } catch (e) {
                console.error(e);
                alert("동기화 명령 전송 실패 (네트워크 연결을 확인하세요)");
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        function resetFilter() {
            const b = document.getElementById("brandSel").value;
            const c = document.getElementById("cateSel").value;
            const q = document.getElementById("invSearch").value.toLowerCase();

            filteredItems = allItems.filter(i => {
                if (!i.isMaster) return false;

                const matchBrand = (b === 'All' || i.brand === b);
                const matchQuery = (i.name.toLowerCase().includes(q) || i.brand.toLowerCase().includes(q) || i.code.toLowerCase().includes(q));

                if (c === '반출') {
                    // '반출' 카테고리가 선택된 경우: 오직 '반출' 아이템만 표시
                    return i.category === '반출' && matchBrand && matchQuery;
                } else {
                    // 그 외 경우: '반출' 아이템은 무조건 제외하고 일반 필터 적용
                    const matchCategory = (c === 'All' || i.category === c);
                    return i.category !== '반출' && matchCategory && matchBrand && matchQuery;
                }
            });

            filteredItems.sort((a, b) => {
                if (a.code > b.code) return -1;
                if (a.code < b.code) return 1;
                return 0;
            });

            document.getElementById("inventoryContainer").innerHTML = "";
            renderInventoryChunk();
        }

        function renderInventoryChunk() {
            const c = document.getElementById("inventoryContainer"), cur = c.children.length;
            filteredItems.slice(cur, cur + 40).forEach(i => c.appendChild(createCard(i)));
            document.getElementById("loadMoreContainer").innerHTML = filteredItems.length > c.children.length ? `<button class="btn btn-outline-primary rounded-pill px-4 btn-sm" onclick="renderInventoryChunk()">더 보기</button>` : "";
        }
        function parseTime(s) { if (!s) return 9999; const m = s.match(/(\d{1,2}):(\d{1,2})/); return m ? parseInt(m[1]) * 60 + parseInt(m[2]) : 9999; }
    </script>
</body>

</html>
