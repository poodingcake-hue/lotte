<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
      :root { --primary: #4361ee; --bg: #f8f9fa; --text: #212529; }
      body { font-family: 'Pretendard', sans-serif; background-color: var(--bg); color: var(--text); padding-bottom: 70px; margin: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
      
      .date-scroller { display: flex; overflow-x: auto; padding: 12px 10px; gap: 10px; background: white; border-bottom: 1px solid #eee; -webkit-overflow-scrolling: touch; position: sticky; top: 0; z-index: 1000; }
      .date-scroller::-webkit-scrollbar { display: none; }
      .date-btn { min-width: 50px; height: 60px; background: #f1f3f5; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; flex-shrink: 0; border: none; cursor: pointer; }
      .date-btn.active { background: var(--primary); color: white; }
      .date-btn .dow { font-size: 10px; opacity: 0.8; }
      .date-btn .day { font-size: 16px; font-weight: 700; }

      .filter-bar { background: white; padding: 10px 15px; display: flex; gap: 8px; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
      .filter-bar select { border-radius: 8px; font-size: 13px; border: 1px solid #ddd; height: 36px; flex: 1; }

      .product-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 12px; }
      .p-card { background: white; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; height: 100%; box-shadow: 0 2px 6px rgba(0,0,0,0.04); position: relative; }
      .p-img-box { position: relative; width: 100%; aspect-ratio: 1/1; background: #fff; display: flex; align-items: center; justify-content: center; }
      .p-img { width: 100%; height: 100%; object-fit: contain; }
      .p-info { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; }
      .p-brand { font-size: 11px; color: var(--primary); font-weight: 700; margin-bottom: 3px; }
      .p-name { font-size: 13px; font-weight: 600; line-height: 1.35; color: #333; min-height: 35px; max-height: 35px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; margin-bottom: 10px; }
      .p-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: center; padding-top: 8px; border-top: 1px solid #f1f1f1; }
      .p-loc { font-size: 10px; background: #f1f3f5; padding: 2px 5px; border-radius: 4px; color: #666; font-weight: 600; }
      .b-badge { position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,0.65); color: white; padding: 2px 6px; border-radius: 5px; font-size: 9px; font-weight: 600; z-index: 5; }

      .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; height: 55px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 2000; }
      .nav-btn { flex: 1; border: none; background: none; color: #adb5bd; display: flex; flex-direction: column; align-items: center; justify-content: center; outline: none; transition: 0.2s; position: relative; }
      .nav-btn.active { color: var(--primary); background: #f8faff; border-top: 2px solid var(--primary); font-weight: 800; }
      .nav-btn span { font-size: 11px; font-weight: 500; margin-top: 2px; }
      .badge-cnt { position: absolute; top: 5px; right: 25%; background: #ef4444; color: white; border-radius: 10px; padding: 1px 5px; font-size: 9px; font-weight: bold; display: none; }

      .modal-content { border-radius: 20px; border: none; overflow: hidden; }
      .modal-body { padding: 0; padding-bottom: 20px; }
      .modal-img-wrap { width: 100%; background: #fff; border-bottom: 1px solid #eee; position: relative; cursor: pointer; }
      #m-img { width: 100%; height: auto; max-height: 45vh; object-fit: contain; }
      .m-product-info-top { font-size: 12px; color: #888; margin: 15px 20px 4px; line-height: 1.2; }
      .m-product-info-top b { color: #222; font-weight: 800; }
      .m-product-title { font-size: 14px; font-weight: 700; color: #111; margin: 0 20px 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: calc(100% - 40px); }
      
      /* 모달 내 탭 버튼 파란색 활성화 */
      .nav-pills .nav-link { color: #666; }
      .nav-pills .nav-link.active { background-color: var(--primary) !important; color: white !important; }

      .modal-main-padding { padding: 0 20px; }
      .loc-input-group { background: #f8f9fa; padding: 12px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eee; }
      .loc-input-group label { font-size: 11px; font-weight: 700; color: var(--primary); display: block; margin-bottom: 5px; }
      .loc-input-group input { width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 8px; font-size: 14px; outline: none; background: white; }

      .table-full-container { margin: 0; padding: 0; width: 100%; overflow-x: auto; }
      .st-table { font-size: 10px !important; width: 100% !important; margin: 0 !important; border-collapse: collapse; table-layout: fixed; border: none !important; }
      .st-table th, .st-table td { border: 1px solid #eee; padding: 10px 2px; text-align: center; vertical-align: middle; overflow: hidden; }
      .col-color { width: 19vw !important; white-space: nowrap !important; font-size: 9px !important; font-weight: 600; background-color: #fcfcfc; }
      .st-table input { width: 100%; border: none; text-align: center; font-size: 11px; outline: none; background: transparent; padding: 0; }
      .st-table th { background: #f8f9fa; font-weight: 700; color: #666; }
      .cell-clickable { color: #333; font-weight: 400; cursor: pointer; text-decoration: none; }
      .cell-clickable:active { background: #eef2ff; font-weight: 700; }

      .outfit-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; padding: 10px 20px; }
      .outfit-box { background: #f8f9fa; border: 1px solid #eee; border-radius: 6px; padding: 8px 4px; text-align: center; cursor: pointer; transition: 0.1s; }
      .outfit-box:active { background: #e9ecef; }
      .outfit-host { font-size: 11px; color: #888; margin-bottom: 2px; }
      .outfit-size { font-size: 12px; font-weight: 700; color: #333; }
      
      .rental-history-item { padding: 8px 20px; border-bottom: 1px solid #f8f9fa; display: flex; justify-content: space-between; font-size: 12px; color: #555; }
      .rh-name { font-weight: 600; color: #333; }
      .rh-info { color: #888; font-size: 11px; }

      .input-form-box { background: #f1f3f5; padding: 15px; margin: 10px 20px; border-radius: 12px; display: none; box-sizing: border-box; }
      .form-row { display: flex; gap: 8px; margin-bottom: 8px; width: 100%; }
      .form-row input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; outline: none; box-sizing: border-box; }
      .of-name { flex: 4; } 
      .of-size { flex: 6; }
      .form-label { font-size: 11px; color: #666; font-weight: 600; margin-bottom: 8px; display: block; }

      #loading-overlay { position: fixed; inset: 0; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
      .spinner { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .time-label { font-size: 16px; font-weight: 800; margin: 15px 12px 10px; display: flex; align-items: center; gap: 8px; }
      .time-label::after { content: ""; flex-grow: 1; height: 1px; background: #ddd; }
      
      .load-more-btn { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #eee; background: white; border-radius: 8px; font-size: 13px; font-weight: 700; color: #555; }

      .rental-tabs { display: flex; padding: 10px 15px; gap: 10px; background: white; border-bottom: 1px solid #eee; }
      .rental-tab-btn { flex: 1; padding: 8px; border: 1px solid #eee; background: #f8f9fa; border-radius: 8px; font-size: 13px; font-weight: 600; color: #666; }
      .rental-tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
      
      .cart-item { background: white; border-radius: 10px; padding: 12px; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border: 1px solid #f1f1f1; }
      .cart-info div { font-size: 13px; font-weight: 700; color: #333; margin-bottom: 2px; }
      .cart-info small { font-size: 11px; color: #888; }
      .cart-actions { display: flex; align-items: center; gap: 8px; }
      .btn-del { width: 24px; height: 24px; border-radius: 50%; background: #fee2e2; color: #ef4444; border: none; font-size: 12px; display: flex; align-items: center; justify-content: center; }

      .full-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: 700; margin-top: 10px; }
      .search-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; margin-bottom: 10px; outline: none; }
      
      .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 12px; z-index: 3000; opacity: 0; transition: 0.3s; pointer-events: none; }
      .toast.show { opacity: 1; }
      
      .section-header { font-size: 13px; font-weight: 700; color: #333; margin: 25px 20px 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 5px; }

      .handling-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 0 20px; }
      .h-card { background: white; border: 1px solid #eee; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative; }
      .h-img-wrap { width: 100%; aspect-ratio: 1/1; background: #f8f9fa; display: flex; align-items: center; justify-content: center; overflow: hidden; }
      .h-img { width: 100%; height: 100%; object-fit: contain; }
      .h-desc { padding: 10px; font-size: 12px; color: #444; line-height: 1.4; word-break: break-all; min-height: 40px; }
      .h-del-btn { position: absolute; top: 5px; right: 5px; background: rgba(255,255,255,0.9); border: 1px solid #ddd; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; display: flex; align-items: center; justify-content: center; color: #666; cursor: pointer; z-index: 5; }
      
      .handling-form-box { background: #f1f3f5; padding: 15px; margin: 10px 20px; border-radius: 12px; display: none; }
      .handling-form-box label { font-size: 11px; font-weight: 700; color: var(--primary); display: block; margin-bottom: 5px; }
      .handling-form-box textarea { width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 8px; font-size: 13px; height: 60px; margin-bottom: 8px; }
      .btn-mini { font-size: 11px; padding: 2px 8px; background: #4361ee; color: white; border: none; border-radius: 4px; cursor: pointer; }
      
      .modal-footer { padding-bottom: 30px; border: 0; }
    </style>
  </head>
  <body>
    <div id="loading-overlay"><div class="spinner"></div><div class="small">데이터 가져오는 중...</div></div>
    
    <!-- 페이지 섹션 -->
    <div id="page-schedule">
      <div class="date-scroller" id="dateScroller"></div>
      <div id="scheduleContainer"></div>
    </div>

    <div id="page-inventory" style="display:none;">
      <div class="filter-bar">
        <select id="brandSel" class="form-select form-select-sm" onchange="resetFilter()"></select>
        <select id="cateSel" class="form-select form-select-sm" onchange="resetFilter()"></select>
      </div>
      <div id="inventoryContainer" class="product-grid"></div>
      <div id="loadMoreContainer" style="padding: 0 12px 20px;"></div>
    </div>

    <div id="page-rental" style="display:none; padding: 0 0 15px 0;">
      <div class="rental-tabs" style="position:sticky; top:0; z-index:100; background:white;">
        <button class="rental-tab-btn active" onclick="switchRentalMode('rent')" id="rt-rent">대여하기</button>
        <button class="rental-tab-btn" onclick="switchRentalMode('return')" id="rt-return">반납하기</button>
      </div>

      <div id="mode-rent" style="padding: 0 15px;">
        <h6 style="margin: 15px 0 10px; font-weight: 700; font-size: 14px;">대여 카트 <span id="cart-cnt" style="color:var(--primary)">0</span></h6>
        <div id="cart-list" style="min-height: 100px; max-height: 50vh; overflow-y: auto;">
            <div class="text-center py-4 small text-muted">재고관리 탭에서 수량을 클릭하여<br>카트에 담아주세요.</div>
        </div>
        <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
            <label style="font-size: 12px; font-weight: 700; margin-bottom: 5px; display: block;">대여자 이름</label>
            <input type="text" id="renter-name" class="search-input" placeholder="이름을 입력하세요">
            <button class="full-btn" id="btn-submit-rental" onclick="submitRental()">대여 처리 완료</button>
        </div>
      </div>

      <div id="mode-return" style="display:none; padding: 0 15px;">
        <div style="margin-top: 15px;">
            <input type="text" id="return-search" class="search-input" placeholder="대여자 이름 또는 상품명 검색" onkeydown="if(event.key==='Enter') searchReturns()">
            <button class="btn btn-sm btn-secondary w-100 mb-3" onclick="searchReturns()">조회</button>
        </div>
        <div id="return-list" style="max-height: 50vh; overflow-y: auto;">
            <div class="text-center py-4 small text-muted">반납할 대여 건을 검색하세요.</div>
        </div>
        <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
             <label style="font-size: 12px; font-weight: 700; margin-bottom: 5px; display: block;">반납 확인자</label>
             <input type="text" id="returner-name" class="search-input" placeholder="확인자 이름">
             <button class="full-btn" id="btn-submit-return" onclick="submitReturn()">반납 처리 완료</button>
        </div>
      </div>
    </div>

    <!-- 하단 네비게이션 -->
    <nav class="bottom-nav">
      <button class="nav-btn active" id="nav-sch" onclick="switchTab('schedule')"><span>편성표</span></button>
      <button class="nav-btn" id="nav-inv" onclick="switchTab('inventory')"><span>재고관리</span></button>
      <button class="nav-btn" id="nav-rent" onclick="switchTab('rental')"><span>대여/반납</span><span id="global-badge" class="badge-cnt">0</span></button>
    </nav>
    
    <!-- 상품 상세 모달 -->
    <div class="modal fade" id="itemModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down"><div class="modal-content"><div class="modal-body">
      <div class="modal-img-wrap mb-2" onclick="openLotteMall()"><img id="m-img" src=""><button type="button" class="btn-close" data-bs-dismiss="modal" style="position:absolute; top:15px; right:15px; background:white; border-radius:50%; padding:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1);"></button></div>
      <div class="m-product-info-top" id="m-info-top"></div>
      <div class="m-product-title" id="m-title"></div>
      
      <div class="modal-main-padding">
          <ul class="nav nav-pills nav-fill mb-3 bg-light p-1 rounded-pill">
              <li class="nav-item"><button class="nav-link active rounded-pill py-2 small" id="t-view" onclick="toggleModalView('view')">재고 현황</button></li>
              <li class="nav-item"><button class="nav-link rounded-pill py-2 small" id="t-outfit" onclick="toggleModalView('outfit')">착장 내역</button></li>
              <li class="nav-item"><button class="nav-link rounded-pill py-2 small" id="t-add" onclick="toggleModalView('add')">입고 등록</button></li>
          </ul>
      </div>

      <!-- 모달: 재고현황 탭 -->
      <div id="v-view" style="display:block;">
         <div id="v-stock-table" class="table-full-container"></div>
         
         <div id="rental-wrapper" style="display:none;">
             <div class="section-header">현재 대여 현황</div>
             <div id="rental-container"></div>
         </div>

         <div class="section-header">
             핸들링 정보 
             <button class="btn-mini" onclick="toggleHandlingForm()">+ 등록</button>
         </div>
         
         <div id="handling-form" class="handling-form-box">
             <label>이미지 등록 (JPG)</label>
             <div class="d-flex align-items-center gap-2 mb-2">
                 <input type="file" id="h-file-input" accept="image/jpeg, image/jpg" class="form-control form-control-sm" onchange="previewImage(this)">
             </div>
             <img id="h-img-preview" src="" style="display:none; width:100px; height:100px; object-fit:cover; border-radius:6px; margin-bottom:8px;">
             
             <label>설명 내용</label>
             <textarea id="h-desc-input" placeholder="설명 입력"></textarea>
             
             <div class="d-flex gap-2">
                 <button class="btn btn-sm btn-secondary flex-grow-1" style="background:#adb5bd; border:none;" onclick="resetHandlingForm()">취소</button>
                 <button class="btn btn-sm btn-secondary flex-grow-1" id="btn-h-save" onclick="saveHandling()">저장</button>
             </div>
         </div>

         <div id="handling-container" class="handling-grid"></div>
      </div>

      <!-- 모달: 착장내역 탭 -->
      <div id="v-outfit" style="display:none;">
          <div id="outfit-container" class="outfit-grid"></div>
          <div class="d-grid px-3 mt-3">
              <button class="btn btn-outline-primary btn-sm" onclick="toggleOutfitForm()">+ 착장내역 등록</button>
          </div>
          <div id="outfit-form" class="input-form-box">
              <span class="form-label">진행자 / 게스트 등록 (최대 2명)</span>
              <div class="form-row"><input type="text" class="of-name" placeholder="이름"><input type="text" class="of-size" placeholder="사이즈"></div>
              <div class="form-row"><input type="text" class="of-name" placeholder="이름"><input type="text" class="of-size" placeholder="사이즈"></div>
              <button class="btn btn-sm btn-primary w-100 mt-2" onclick="saveOutfit()">저장</button>
          </div>
      </div>

      <!-- 모달: 입고등록 탭 -->
      <div id="v-add" style="display:none;">
         <div class="modal-main-padding"><div class="loc-input-group"><label>입고 위치 입력 (G열 저장)</label><input type="text" id="in-location" placeholder="예: 행거A1-1"></div></div>
         <div id="add-table-container" class="table-full-container"></div>
         <div class="modal-main-padding"><div class="d-flex gap-2 mt-3 mb-4"><button class="btn btn-sm btn-outline-secondary w-100 py-2" onclick="addRow()">+ 색상</button><button class="btn btn-sm btn-outline-secondary w-100 py-2" onclick="addCol()">+ 사이즈</button></div></div>
      </div>
      
    </div><div class="modal-footer border-0"><button type="button" class="btn btn-primary w-100 py-2" id="btn-save" style="display:none;" onclick="saveData()">저장</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_URL = "https://script.google.com/macros/s/AKfycbwGGJsflqUqpv4ep9NU8BV_zXpqTDzrcgGER6vKzKOeOBNIVeZFyAJdbSl3pWscSyTA/exec";
      let curItem = null, allItems = [], selDate = null, modalObj = null;
      let allStockMap = {}, allRentals = [], allOutfits = [], allHandlings = {};
      let invLimit = 30, filteredItems = [], cart = []; 

      // 뒤로가기 로직
      window.onpopstate = function() {
        const modalEl = document.getElementById('itemModal');
        if (modalEl && modalEl.classList.contains('show')) {
            bootstrap.Modal.getInstance(modalEl).hide();
        } else if (document.getElementById('page-schedule').style.display === 'none') {
            switchTabUI('schedule');
        }
      };

      window.onload = function() { 
          window.history.replaceState({page: 'schedule'}, '');
          fetchData("getInitialData"); 
      };

      function fetchData(action, params = "") {
        if (action === "getInitialData") {
            fetch(`data.json?v=${new Date().getTime()}`)
              .then(res => res.json())
              .then(data => handleResponse(data, action))
              .catch(() => {
                  fetch(`${API_URL}?action=${action}${params}`)
                      .then(res => res.json())
                      .then(data => handleResponse(data, action));
              });
            return;
        }
        fetch(`${API_URL}?action=${action}${params}`)
          .then(res => res.json())
          .then(data => handleResponse(data, action))
          .catch(err => handleError(err));
      }

      function fetchPost(action, payload) {
        fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ action: action, payload: payload }),
            headers: { "Content-Type": "text/plain;charset=utf-8" }
        })
        .then(res => res.json())
        .then(data => handleResponse(data, action))
        .catch(err => handleError(err));
      }

      function handleResponse(data, action) {
        if (action == "getInitialData") onDataLoad(data);
        else if (action == "saveInventoryData") {
            alert(data); 
            // 처리 후 입고 양식 초기화 및 탭 전환
            document.querySelectorAll("#add-table input[type='number']").forEach(i => i.value = ""); 
            const btn = document.getElementById("btn-save");
            btn.disabled = false; btn.innerText = "저장";
            fetchData("getInitialData");
            toggleModalView('view');
        } else if (action == "processRental") {
            alert(data.message); 
            // 처리 후 대여 양식 초기화
            cart = []; renderCart(); 
            document.getElementById("renter-name").value = "";
            document.getElementById("btn-submit-rental").disabled = false;
            document.getElementById("btn-submit-rental").innerText = "대여 처리 완료";
            fetchData("getInitialData");
        } else if (action == "processReturn") {
            alert(data.message);
            // 처리 후 반납 양식 초기화
            document.getElementById("return-list").innerHTML = '<div class="text-center py-4 small text-muted">반납할 대여 건을 검색하세요.</div>';
            document.getElementById("return-search").value = "";
            document.getElementById("returner-name").value = "";
            document.getElementById("btn-submit-return").disabled = false;
            document.getElementById("btn-submit-return").innerText = "반납 처리 완료";
            fetchData("getInitialData");
        } else if (action == "saveOutfitsBulk" || action == "saveHandlingInfo" || action == "deleteHandlingInfo") {
            alert(data.message);
            document.getElementById("btn-h-save").disabled = false;
            document.getElementById("btn-h-save").innerText = "저장";
            fetchData("getInitialData");
        }
      }

      function handleError(err) { 
          console.error(err); 
          document.querySelectorAll(".full-btn, .btn-primary").forEach(b => b.disabled = false);
          alert("오류 발생: " + err); 
      }

      function onDataLoad(data) {
        allItems = data.items || []; allStockMap = data.stockMap || {}; allRentals = data.rentals || []; 
        allOutfits = data.outfits || []; allHandlings = data.handlings || {};
        
        modalObj = new bootstrap.Modal(document.getElementById('itemModal'));
        const b = document.getElementById("brandSel"), c = document.getElementById("cateSel");
        b.innerHTML = '<option value="All">전체 브랜드</option>'; c.innerHTML = '<option value="All">전체 카테고리</option>';
        data.brands.forEach(v => b.add(new Option(v, v))); data.categories.forEach(v => c.add(new Option(v, v)));
        
        const scroller = document.getElementById("dateScroller"); scroller.innerHTML = "";
        if(data.dates.length > 0) {
          if(!selDate) selDate = data.dates[0];
          data.dates.forEach(d => {
            const dateObj = new Date(d); const btn = document.createElement("div");
            btn.className = `date-btn ${d === selDate ? 'active' : ''}`;
            btn.innerHTML = `<span class="dow">${"일월화수목금토"[dateObj.getDay()]}</span><span class="day">${dateObj.getDate()}</span>`;
            btn.onclick = () => { document.querySelectorAll('.date-btn').forEach(el => el.classList.remove('active')); btn.classList.add('active'); selDate = d; renderSchedule(); };
            scroller.appendChild(btn);
          });
        }
        
        const upBtn = document.createElement("div");
        upBtn.className = "date-btn"; upBtn.style.background = "#212529"; upBtn.style.color = "white";
        upBtn.innerHTML = `<span class="material-icons-round">sync</span><span class="dow">UP</span>`;
        upBtn.onclick = requestGithubUpdate; scroller.appendChild(upBtn);

        renderSchedule(); 
        if(curItem && document.getElementById('itemModal').classList.contains('show')) {
            renderStock(allStockMap[curItem.code] || []);
            renderHandling(curItem.code); renderOutfits(curItem.code); renderCurrentRentals(curItem.code);
        }
        document.getElementById('loading-overlay').style.display = 'none';
      }

      function openModal(item) {
        curItem = item;
        document.getElementById("m-info-top").innerHTML = `<b>${item.brand}</b> | ${item.code} | <b>${item.location || '-'}</b>`;
        document.getElementById("m-title").innerText = item.name.replace(/(\r\n|\n|\r)/gm, " ");
        document.getElementById("m-img").src = item.image || `https://image2.lotteimall.com/goods/${String(item.code).substring(6, 8)}/${String(item.code).substring(4, 6)}/${String(item.code).substring(2, 4)}/${item.code}_L.jpg`;
        
        // 탭 상태 초기화 (파란색 활성화 포함)
        toggleModalView('view');
        
        renderStock(allStockMap[item.code] || []);
        renderOutfits(item.code); renderCurrentRentals(item.code); renderHandling(item.code);

        // 입고 등록 테이블 초기화
        const colors = (item.colors || "기본").split(","), sizes = (item.sizes || "Free").split(",");
        let ah = `<table class="st-table" id="add-table"><thead><tr><th class="col-color">색상</th>${sizes.map(s=>`<th><input type="text" value="${s.trim()}" style="font-weight:bold;"></th>`).join("")}</tr></thead><tbody>`;
        colors.forEach(c => { ah += `<tr><td class="col-color">${c.trim()}</td>` + sizes.map(()=>`<td><input type="number"></td>`).join("") + "</tr>"; });
        document.getElementById("add-table-container").innerHTML = ah + "</tbody></table>";
        
        window.history.pushState({page: 'modal'}, '');
        modalObj.show();
      }

      function toggleModalView(v) { 
        // 화면 전환
        ['v-view','v-outfit','v-add'].forEach(id => document.getElementById(id).style.display = (id === 'v-'+v ? 'block' : 'none'));
        // 탭 파란색 효과 (Bootstrap active 클래스 제어)
        ['t-view','t-outfit','t-add'].forEach(id => {
            const btn = document.getElementById(id);
            if (id === 't-'+v) btn.classList.add('active');
            else btn.classList.remove('active');
        });
        // 저장 버튼 제어
        document.getElementById('btn-save').style.display = (v === 'add' ? 'block' : 'none');
      }

      function renderStock(stock) {
        const container = document.getElementById("v-stock-table");
        if(!stock || !stock.length) { container.innerHTML = "<div class='text-center py-4 small'>재고 없음</div>"; return; }
        const sizes = sortSizes([...new Set(stock.map(s => s.size))]); const colors = [...new Set(stock.map(s => s.color))].sort();
        let h = `<table class="st-table"><thead><tr><th class="col-color">색상</th>${sizes.map(s=>`<th>${s}</th>`).join("")}</tr></thead><tbody>`;
        colors.forEach(c => { h += `<tr><td class="col-color">${c}</td>` + sizes.map(s => { const q = stock.filter(x => x.color === c && x.size === s).reduce((a, b) => a + Number(b.qty), 0); return `<td ${q > 0 ? `class="cell-clickable" onclick="addToCart('${curItem.code}', '${curItem.name.replace(/'/g, "")}', '${c}', '${s}', ${q})"` : ''}>${q || 0}</td>`; }).join("") + "</tr>"; }); container.innerHTML = h + "</tbody></table>";
      }

      function sortSizes(sizes) {
        const order = ["44", "55", "66", "77", "88", "XS", "S", "M", "L", "XL", "100", "105", "110"];
        return sizes.sort((a, b) => { let idxA = order.indexOf(a), idxB = order.indexOf(b); if (idxA !== -1 && idxB !== -1) return idxA - idxB; return a.localeCompare(b); });
      }

      function resetFilter() {
        invLimit = 30; document.getElementById("inventoryContainer").innerHTML = "";
        const b = document.getElementById("brandSel").value, c = document.getElementById("cateSel").value;
        filteredItems = allItems.filter(i => i.isMaster && (b==='All' || i.brand === b) && (c==='All' || i.category === c));
        renderInventoryChunk();
      }
      
      function renderInventoryChunk() { 
        const container = document.getElementById("inventoryContainer"); const currentCount = container.children.length;
        const nextBatch = filteredItems.slice(currentCount, currentCount + invLimit);
        nextBatch.forEach(i => container.appendChild(createCard(i)));
        const btnContainer = document.getElementById("loadMoreContainer");
        btnContainer.innerHTML = filteredItems.length > container.children.length ? `<button class="load-more-btn" onclick="renderInventoryChunk()">더 보기</button>` : "";
      }

      function renderSchedule() {
        const container = document.getElementById("scheduleContainer"); container.innerHTML = "";
        const filtered = allItems.filter(i => !i.isMaster && i.dateKey === selDate).sort((a,b) => parseTime(a.date) - parseTime(b.date));
        if (!filtered.length) { container.innerHTML = '<div class="text-center py-5 small">편성 없음</div>'; return; }
        const groups = {}; filtered.forEach(i => { const t = i.date && i.date.match(/\d{1,2}:\d{1,2}/) ? i.date.match(/\d{1,2}:\d{1,2}/)[0] : "시간미정"; if(!groups[t]) groups[t] = []; groups[t].push(i); });
        Object.keys(groups).forEach(t => {
          const g = document.createElement("div"); g.innerHTML = `<div class="time-label">${t}</div>`;
          const grid = document.createElement("div"); grid.className = "product-grid";
          groups[t].forEach(item => grid.appendChild(createCard(item)));
          g.appendChild(grid); container.appendChild(g);
        });
      }

      function createCard(item) {
        const div = document.createElement("div"); div.className = "p-card"; div.onclick = () => openModal(item);
        const timeMatch = item.date && item.date.match(/\d{1,2}:\d{1,2}/);
        div.innerHTML = `<div class="p-img-box">${timeMatch ? `<div class="b-badge">${timeMatch[0]}</div>` : ''}<img src="${item.image || ''}" class="p-img" loading="lazy"></div><div class="p-info"><div class="p-brand">${item.brand || ""}</div><div class="p-name">${item.name || ""}</div><div class="p-footer"><span class="p-loc">${item.location || "-"}</span></div></div>`;
        return div;
      }

      function switchTab(t) { window.history.pushState({page: t}, ''); switchTabUI(t); }
      function switchTabUI(t) {
        ['schedule','inventory','rental'].forEach(p => document.getElementById('page-'+p).style.display = (p===t?'block':'none'));
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('nav-'+(t==='schedule'?'sch':t==='inventory'?'inv':'rent')).classList.add('active');
        if(t==='inventory' && document.getElementById("inventoryContainer").innerHTML==="") resetFilter();
      }

      function addToCart(code, name, color, size, q) {
        const exist = cart.find(i => i.code === code && i.color === color && i.size === size);
        if(exist) { if(exist.qty < q) exist.qty++; else return showToast("재고 부족"); }
        else cart.push({code, name, color, size, qty: 1, max: q});
        showToast("카트에 담김"); renderCart();
      }

      function renderCart() {
        const list = document.getElementById("cart-list"), badge = document.getElementById("global-badge");
        const total = cart.reduce((a,b) => a+b.qty, 0); 
        document.getElementById("cart-cnt").innerText = total; badge.innerText = total; badge.style.display = total > 0 ? "block" : "none";
        if(cart.length === 0) { list.innerHTML = '<div class="text-center py-4 small text-muted">카트가 비어있습니다.</div>'; return; }
        list.innerHTML = cart.map((item, idx) => `<div class="cart-item"><div class="cart-info"><div>${item.name}</div><small>${item.color}/${item.size}</small></div><div class="cart-actions"><b>${item.qty}</b><button class="btn-del" onclick="cart.splice(${idx},1);renderCart();">✕</button></div></div>`).join("");
      }

      function submitRental() {
        const name = document.getElementById("renter-name").value.trim();
        if(!name || cart.length === 0) return alert("대여자 이름과 카트 정보를 확인하세요.");
        const btn = document.getElementById("btn-submit-rental");
        btn.disabled = true; btn.innerText = "등록중입니다...";
        fetchData("processRental", `&payload=${encodeURIComponent(JSON.stringify({ items: cart, renter: name }))}`);
      }

      function searchReturns() {
        const q = document.getElementById("return-search").value.trim(); const list = document.getElementById("return-list");
        const res = allRentals.filter(r => r.renter.includes(q) || r.name.includes(q));
        if(res.length === 0) { list.innerHTML = '<div class="text-center py-4 small text-muted">검색 결과 없음</div>'; return; }
        list.innerHTML = res.map((r, idx) => `<div class="cart-item"><div class="d-flex align-items-center gap-2"><input type="checkbox" class="return-chk" data-idx="${idx}"><div><b>${r.name}</b><br><small>${r.renter} | ${r.color}/${r.size}</small></div></div></div>`).join("");
        list.dataset.searchResults = JSON.stringify(res);
      }

      function submitReturn() {
        const list = document.getElementById("return-list"), name = document.getElementById("returner-name").value.trim();
        const checks = list.querySelectorAll(".return-chk:checked"); if(!name || checks.length === 0) return alert("반납 항목과 확인자를 입력하세요.");
        const btn = document.getElementById("btn-submit-return");
        btn.disabled = true; btn.innerText = "등록중입니다...";
        const data = JSON.parse(list.dataset.searchResults);
        const targets = Array.from(checks).map(c => data[c.dataset.idx]);
        fetchData("processReturn", `&payload=${encodeURIComponent(JSON.stringify({ items: targets, returner: name }))}`);
      }

      function saveData() {
        const table = document.getElementById("add-table"), headers = Array.from(table.rows[0].cells).slice(1).map(c => c.querySelector("input").value.trim());
        const loc = document.getElementById("in-location").value.trim(), matrix = [];
        for(let i=1; i<table.rows.length; i++) {
          const color = table.rows[i].cells[0].innerText.trim();
          headers.forEach((size, idx) => { const qty = table.rows[i].cells[idx+1].querySelector("input").value; if(qty > 0) matrix.push({ color, size, qty: Number(qty) }); });
        }
        if(matrix.length === 0) return alert("수량을 입력하세요.");
        const btn = document.getElementById("btn-save");
        btn.disabled = true; btn.innerText = "등록중입니다...";
        fetchData("saveInventoryData", `&payload=${encodeURIComponent(JSON.stringify({ code: curItem.code, combinedName: curItem.brand + " " + curItem.name, name: curItem.name, matrix: matrix, location: loc }))}`);
      }

      function saveHandling() {
        const f = document.getElementById("h-file-input").files[0], d = document.getElementById("h-desc-input").value;
        const btn = document.getElementById("btn-h-save");
        btn.disabled = true; btn.innerText = "저장 중...";
        if(!f) return fetchPost("saveHandlingInfo", {code: curItem.code, desc: d});
        const r = new FileReader(); r.onload = e => {
          const img = new Image(); img.onload = () => {
            const canvas = document.createElement('canvas'), ctx = canvas.getContext('2d'), MAX = 800;
            let w = img.width, h = img.height; if(w > MAX) { h *= MAX/w; w = MAX; }
            canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h);
            fetchPost("saveHandlingInfo", {code: curItem.code, desc: d, imageBase64: canvas.toDataURL("image/jpeg", 0.6).split(",")[1], fileName: f.name, mimeType: "image/jpeg"});
          }; img.src = e.target.result;
        }; r.readAsDataURL(f);
      }

      function renderHandling(code) {
        const container = document.getElementById("handling-container"), list = allHandlings[code];
        if(!list || !list.length) { container.innerHTML = '<div class="small text-center w-100 py-3">핸들링 정보 없음</div>'; return; }
        container.innerHTML = list.map(h => `<div class="h-card"><div class="h-del-btn" onclick="fetchPost('deleteHandlingInfo',{code:curItem.code,img:'${h.img}',desc:'${h.desc.replace(/'/g,"")}'})">✕</div>${h.img?`<div class="h-img-wrap"><img src="${h.img}" class="h-img"></div>`:''}<div class="h-desc">${h.desc}</div></div>`).join("");
      }

      function renderOutfits(code) {
        const container = document.getElementById("outfit-container"), list = allOutfits.filter(o => o.code == code);
        container.innerHTML = list.length ? list.map(o => `<div class="outfit-box" onclick="editOutfit('${o.host}', '${o.size}')"><div class="outfit-host">${o.host}</div><div class="outfit-size">${o.size}</div></div>`).join("") : '<div class="text-center w-100 small">착장 내역 없음</div>';
      }
      function editOutfit(h, s) {
        const ns = prompt(`${h}님 사이즈 수정`, s);
        if(ns && ns !== s) fetchData("saveOutfitsBulk", `&payload=${encodeURIComponent(JSON.stringify([{ code: curItem.code, host: h, size: ns.trim() }]))}`);
      }
      function saveOutfit() {
        const ns = document.querySelectorAll('.of-name'), sz = document.querySelectorAll('.of-size'), p = [];
        ns.forEach((n, i) => { if(n.value.trim() && sz[i].value.trim()) p.push({code: curItem.code, host: n.value.trim(), size: sz[i].value.trim()}); });
        if(p.length) fetchData("saveOutfitsBulk", `&payload=${encodeURIComponent(JSON.stringify(p))}`);
      }

      function renderCurrentRentals(code) {
        const list = allRentals.filter(r => r.code == code), wrapper = document.getElementById("rental-wrapper");
        wrapper.style.display = list.length ? 'block' : 'none';
        document.getElementById("rental-container").innerHTML = list.map(r => `<div class="rental-history-item"><span class="rh-name">${r.renter}</span><span class="rh-info">${r.color}/${r.size} (${r.qty})</span></div>`).join("");
      }

      function previewImage(i) { if(i.files && i.files[0]) { var r = new FileReader(); r.onload = e => { document.getElementById('h-img-preview').src = e.target.result; document.getElementById('h-img-preview').style.display = 'block'; }; r.readAsDataURL(i.files[0]); } }
      function toggleHandlingForm() { var f = document.getElementById("handling-form"); f.style.display = (f.style.display === "block" ? "none" : "block"); }
      function resetHandlingForm() { document.getElementById("h-file-input").value = ""; document.getElementById("h-desc-input").value = ""; document.getElementById("h-img-preview").style.display = 'none'; }
      function toggleOutfitForm() { var f = document.getElementById("outfit-form"); f.style.display = (f.style.display === "block" ? "none" : "block"); }
      function addRow() { var t = document.getElementById("add-table"), r = t.insertRow(); r.innerHTML = `<td class="col-color"><input type="text" placeholder="색상"></td>` + `<td><input type="number"></td>`.repeat(t.rows[0].cells.length - 1); }
      function addCol() { var t = document.getElementById("add-table"); t.rows[0].appendChild(document.createElement("th")).innerHTML = `<input type="text" placeholder="사이즈">`; for(var i=1;i<t.rows.length;i++) t.rows[i].insertCell().innerHTML = `<input type="number">`; }
      function switchRentalMode(m) { ['rent','return'].forEach(id => document.getElementById('mode-'+id).style.display = (id===m?'block':'none')); document.getElementById('rt-rent').classList.toggle('active',m==='rent'); document.getElementById('rt-return').classList.toggle('active',m==='return'); }
      function requestGithubUpdate() { if(confirm("깃허브와 동기화를 시작할까요?")) fetchPost("forceUpdate", {}); }
      function parseTime(s) { if(!s) return 9999; const m = s.match(/(\d{1,2}):(\d{1,2})/); return m ? parseInt(m[1])*60+parseInt(m[2]) : 9999; }
      function showToast(m) { const t = document.createElement('div'); t.className = 'toast show'; t.innerText = m; document.body.appendChild(t); setTimeout(()=>t.remove(), 2000); }
      function openLotteMall() { if(curItem) window.open("https://www.lotteimall.com/goods/viewGoodsDetail.lotte?goods_no="+curItem.code); }
      function updateLocalStock(c, l) { if(l) { curItem.location = l; document.getElementById("m-info-top").innerHTML = `<b>${curItem.brand}</b>|${curItem.code}|<b>${l}</b>`; } }
    </script>
  </body>
</html>

