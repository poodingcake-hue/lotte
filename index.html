<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>LOTTE WM Dashboard Professional</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        :root { --primary: #4361ee; --primary-soft: #eef2ff; --bg: #f8f9fa; --text: #1a1a1a; --nav-height: 64px; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding-top: var(--nav-height); letter-spacing: -0.5px; }

        .top-nav { position: fixed; top: 0; left: 0; right: 0; height: var(--nav-height); background: white; box-shadow: 0 1px 10px rgba(0,0,0,0.05); z-index: 2000; display: flex; align-items: center; border: none; }
        .nav-container, .main-content { width: 100%; margin: 0 auto; padding: 0 15px; }
        @media (min-width: 992px) { .nav-container, .main-content { width: 74%; max-width: 1800px; } }
        .nav-container { display: flex; justify-content: space-between; align-items: center; }
        .nav-logo { font-weight: 800; font-size: 1.5rem; color: var(--primary); text-decoration: none; cursor: pointer; }
        .nav-menu { display: flex; gap: 5px; align-items: center; }
        .nav-item { border: none; background: none; padding: 8px 20px; border-radius: 10px; font-size: 16px; font-weight: 700; color: #444; transition: 0.2s; }
        .nav-item.active { background: var(--primary-soft); color: var(--primary); }

        .main-content { padding-top: 15px; padding-bottom: 40px; }
        .page-section { display: none; }
        .page-section.active { display: block; }

        .dash-layout { display: grid; grid-template-columns: 1fr; gap: 10px; align-items: start; }
        @media (min-width: 992px) { .dash-layout { grid-template-columns: 400px 1fr; } }
        .dash-card { background: white; border-radius: 12px; padding: 10px; border: 1px solid #eee; margin-bottom: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.02); }
        .dash-title { font-size: 13px; font-weight: 800; color: #444; margin-bottom: 8px; display: block; border-bottom: 1px solid #f8f9fa; padding-bottom: 4px; }

        .integrated-section { background: white; border-radius: 12px; border: 1px solid #eee; overflow: hidden; }
        .img-header-overlay { padding: 15px 15px 8px 15px; background: white; }
        .det-product-name { font-size: 19px; font-weight: 800; color: #000; line-height: 1.2; margin-bottom: 6px; }
        .det-sub-info { display: flex; gap: 6px; align-items: center; }
        .badge-item { padding: 3px 8px; border-radius: 5px; font-size: 11px; font-weight: 700; border: 1px solid #dee2e6; }
        .badge-code { background: #f8f9fa; color: #495057; }
        .badge-loc { background: var(--primary); color: white; border: none; }
        .det-main-img { width: 80%; margin: 0 auto; padding: 5px; display: block; object-fit: contain; }

        .compact-table .st-table { width: 100%; font-size: 12.5px; border-collapse: separate; border-spacing: 0; border: 1px solid #eee; border-radius: 8px; overflow: hidden; table-layout: fixed; }
        .compact-table th { background: #f8f9fa; padding: 6px 4px; font-weight: 800; color: #333; border-bottom: 1px solid #eee; text-align: center; }
        .compact-table td { padding: 8px 4px; border-bottom: 1px solid #eee; text-align: center; color: #000 !important; font-weight: 700; }
        .compact-table td:first-child { width: 100px; background: #fcfcfc; font-weight: 700; }

        .info-card-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }
        @media (min-width: 576px) { .info-card-grid { grid-template-columns: repeat(4, 1fr); } }
        .info-item-card { background: white; border: 1px solid #eee; border-radius: 10px; padding: 10px 4px; text-align: center; position: relative; }
        .info-card-top { font-size: 13px; font-weight: 700; color: #000; margin-bottom: 1px; display: block; }
        .info-card-bottom { font-size: 17px; font-weight: 800; color: #000; display: block; }
        
        .delete-btn { position: absolute; top: 2px; right: 5px; color: #ccc; cursor: pointer; font-size: 12px; border: none; background: none; }
        .delete-btn:hover { color: red; }

        .time-divider { display: flex; align-items: center; gap: 8px; margin: 15px 0 10px; font-weight: 800; color: var(--primary); font-size: 14px; }
        .time-divider::after { content: ""; flex-grow: 1; height: 1px; background: #e0e0e0; }

        .product-grid { display: grid; gap: 10px; grid-template-columns: repeat(2, 1fr); }
        @media (min-width: 768px) { .product-grid { grid-template-columns: repeat(4, 1fr); } }
        .p-card { background: white; border-radius: 10px; overflow: hidden; border: 1px solid #eee; cursor: pointer; height: 100%; display: flex; flex-direction: column; transition: 0.15s; }
        .p-card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.06); }
        .p-img-box { aspect-ratio: 1/1.1; background: #fff; }
        .p-img { width: 100%; height: 100%; object-fit: contain; }
        .p-info { padding: 10px; flex-grow: 1; }
        .p-brand { font-size: 11px; color: var(--primary); font-weight: 800; margin-bottom: 2px; }
        .p-name { font-size: 12.5px; font-weight: 600; line-height: 1.3; height: 32px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }

        #loading-overlay { position: fixed; inset: 0; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }

        .date-scroller { display: flex; overflow-x: auto; padding: 8px 0; gap: 8px; position: sticky; top: var(--nav-height); background: var(--bg); z-index: 1000; }
        .date-btn { min-width: 60px; height: 68px; background: white; border-radius: 12px; border: 1px solid #eee; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.15s; }
        .date-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .add-btn { background: var(--primary); color: white; border: none; border-radius: 5px; padding: 5px 10px; font-size: 12px; margin-top: 5px; width: 100%; }
    </style>
</head>
<body>

    <div id="loading-overlay"><div class="spinner"></div><div class="mt-2 fw-bold small">LOTTE WM</div></div>

    <nav class="top-nav">
        <div class="nav-container">
            <a href="javascript:void(0)" class="nav-logo" onclick="handleNavClick('schedule')">LOTTE WM</a>
            <div class="nav-menu">
                <button class="nav-item active" id="nav-sch" onclick="handleNavClick('schedule')">편성표</button>
                <button class="nav-item" id="nav-inv" onclick="handleNavClick('inventory')">재고관리</button>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <section id="page-schedule" class="page-section">
            <div id="dateScroller" class="date-scroller"></div>
            <div id="scheduleContainer"></div>
        </section>

        <section id="page-inventory" class="page-section">
            <div class="card border-0 shadow-sm p-2 mb-2 rounded-3">
                <div class="row g-2">
                    <div class="col-6"><select id="brandSel" class="form-select form-select-sm border-0 bg-light" onchange="resetFilter()"></select></div>
                    <div class="col-6"><select id="cateSel" class="form-select form-select-sm border-0 bg-light" onchange="resetFilter()"></select></div>
                    <div class="col-12"><input type="text" id="invSearch" class="form-control form-control-sm border-0 bg-light" placeholder="상품명, 브랜드, 코드 검색" onkeyup="resetFilter()"></div>
                </div>
            </div>
            <div id="inventoryContainer" class="product-grid"></div>
            <div id="loadMoreContainer" class="text-center mt-3"></div>
        </section>

        <section id="page-detail" class="page-section">
            <div class="dash-layout">
                <div class="dash-left">
                    <div class="integrated-section">
                        <div class="img-header-overlay">
                            <h1 class="det-product-name" id="det-name">NAME</h1>
                            <div class="det-sub-info">
                                <span id="det-code" class="badge-item badge-code">CODE</span>
                                <span id="det-loc" class="badge-item badge-loc">LOCATION</span>
                            </div>
                        </div>
                        <img id="det-img" src="" alt="상품이미지" class="det-main-img">
                    </div>
                </div>
                <div class="dash-right">
                    <div class="dash-card">
                        <span class="dash-title">실시간 재고 현황</span>
                        <div id="v-stock-table" class="compact-table"></div>
                    </div>
                    <div class="dash-card">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="dash-title mb-0" style="border:none;">착장 정보</span>
                            <button class="btn btn-sm btn-outline-primary py-0" onclick="addOutfitData()">+ 추가</button>
                        </div>
                        <div id="v-outfit-container" class="info-card-grid"></div>
                    </div>
                    <div id="v-rental-card" class="dash-card">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="dash-title mb-0" style="border:none;">현재 대여 현황</span>
                            <button class="btn btn-sm btn-outline-primary py-0" onclick="addRentalData()">+ 대여</button>
                        </div>
                        <div id="v-rental-list" class="info-card-grid"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        /**
         * [설정] 본사 GAS 차단 우회용 설정
         * GITHUB_TOKEN: 보안상 직접 노출은 위험하므로, 실행 시 물어보거나 
         * 본인만 아는 장소에 보관하세요. (여기서는 예시로 설명)
         */
        const GITHUB_USER = "poodingcake-hue";
        const GITHUB_REPO = "lotte";
        const GITHUB_TOKEN = ""; // ◀ 여기에 토큰을 넣으면 저장이 가능해집니다.

        let allItems = [], allStockMap = {}, allRentals = [], allOutfits = [], selDate = null, filteredItems = [];

        window.onload = () => { fetchGitHubData(); };
        window.onpopstate = (e) => { if (e.state && e.state.page) renderPageUI(e.state.page, e.state.item); };

        async function fetchGitHubData() {
            document.getElementById('loading-overlay').style.display = 'flex';
            try {
                const ts = new Date().getTime();
                // 1. 마스터 데이터 (시트에서 생성된 정적 파일)
                const masterRes = await fetch(`data.json?v=${ts}`);
                const masterData = await masterRes.json();
                
                // 2. 실시간 데이터 (깃허브 API를 통해 별도 관리)
                // 깃허브 Pages는 반영이 느리므로, API raw 주소로 직접 호출하여 실시간성 확보
                const rentalsRes = await fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/rentals.json?v=${ts}`);
                allRentals = await rentalsRes.json();

                const outfitsRes = await fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/outfits.json?v=${ts}`);
                allOutfits = await outfitsRes.json();

                onDataLoad(masterData);
            } catch (err) {
                console.error("데이터 로드 실패:", err);
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        /**
         * [저장] 깃허브 API를 이용한 직접 저장 로직 (GAS 우회)
         */
        async function saveToGitHub(fileName, data) {
            if (!GITHUB_TOKEN) {
                const token = prompt("깃허브 토큰이 필요합니다:");
                if (!token) return;
                // 임시로 메모리에 저장 (세션 동안 유지)
                window.G_TOKEN = token;
            }
            
            const token = GITHUB_TOKEN || window.G_TOKEN;
            const path = fileName;
            const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${path}`;

            // 1. 기존 파일의 SHA 값을 가져와야 덮어쓰기가 가능함
            const getRes = await fetch(url, { headers: { Authorization: `token ${token}` } });
            const fileData = await getRes.json();
            const sha = fileData.sha;

            // 2. 파일 업데이트
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
            const putRes = await fetch(url, {
                method: "PUT",
                headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({ message: `Update ${fileName}`, content: content, sha: sha })
            });

            if (putRes.ok) {
                alert("저장 완료! 약 10초 후 새로고침하세요.");
                location.reload();
            } else {
                alert("저장 실패. 토큰이나 권한을 확인하세요.");
            }
        }

        // --- 기존 UI 제어 로직 ---

        function onDataLoad(data) {
            allItems = data.items || []; allStockMap = data.stockMap || {};
            const b = document.getElementById("brandSel"), c = document.getElementById("cateSel");
            b.innerHTML = '<option value="All">브랜드 전체</option>'; c.innerHTML = '<option value="All">카테고리 전체</option>';
            data.brands.forEach(v => b.add(new Option(v, v))); data.categories.forEach(v => c.add(new Option(v, v)));
            const scroller = document.getElementById("dateScroller"); scroller.innerHTML = "";
            if(data.dates && data.dates.length > 0) {
                if(!selDate) selDate = data.dates[0];
                data.dates.forEach(d => {
                    const dateObj = new Date(d); const btn = document.createElement("div");
                    btn.className = `date-btn ${d === selDate ? 'active' : ''}`;
                    btn.innerHTML = `<span class="dow">${"일월화수목금토"[dateObj.getDay()]}</span><span class="day">${dateObj.getDate()}</span>`;
                    btn.onclick = () => { selDate = d; renderSchedule(); };
                    scroller.appendChild(btn);
                });
            }
            renderPageUI('schedule');
        }

        function handleNavClick(p) { history.pushState({page: p}, '', '#' + p); renderPageUI(p); }
        function renderPageUI(t, item = null) {
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById('page-'+t).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.toggle('active', btn.id === (t==='schedule'?'nav-sch':'nav-inv')));
            if(t === 'schedule') renderSchedule();
            if(t === 'inventory' && !document.getElementById("inventoryContainer").children.length) resetFilter();
            if(t === 'detail' && item) renderDetailUI(item);
            window.scrollTo(0,0);
        }

        function renderSchedule() {
            const container = document.getElementById("scheduleContainer"); container.innerHTML = "";
            document.querySelectorAll('.date-btn').forEach(btn => btn.classList.toggle('active', parseInt(btn.querySelector('.day').innerText) === new Date(selDate).getDate()));
            const filtered = allItems.filter(i => !i.isMaster && i.dateKey === selDate).sort((a,b)=>parseTime(a.date)-parseTime(b.date));
            const groups = {};
            filtered.forEach(item => {
                const tmMatch = item.date ? item.date.match(/(\d{1,2}:\d{1,2})/) : null;
                const tm = tmMatch ? tmMatch[1] : "시간미정";
                if (!groups[tm]) groups[tm] = []; groups[tm].push(item);
            });
            Object.keys(groups).sort().forEach(tm => {
                const div = document.createElement("div"); div.className = "time-divider";
                div.innerHTML = `${tm} 방송`;
                container.appendChild(div);
                const grid = document.createElement("div"); grid.className = "product-grid";
                groups[tm].forEach(i => grid.appendChild(createCard(i)));
                container.appendChild(grid);
            });
        }

        function createCard(i) {
            const div = document.createElement("div"); div.className = "p-card"; 
            div.onclick = () => { history.pushState({page: 'detail', item: i}, '', '#detail'); renderPageUI('detail', i); };
            div.innerHTML = `<div class="p-img-box"><img src="${i.image || ''}" class="p-img"></div><div class="p-info"><div class="p-brand">${i.brand}</div><div class="p-name">${i.name}</div></div>`;
            return div;
        }

        function renderDetailUI(i) {
            curItem = i; // 전역 저장
            document.getElementById("det-name").innerText = `${i.brand} ${i.name}`;
            document.getElementById("det-code").innerText = i.code;
            document.getElementById("det-loc").innerText = i.location || "-";
            document.getElementById("det-img").src = i.image || "";
            
            const stock = allStockMap[i.code] || [];
            const sizes = []; const colors = [];
            stock.forEach(s => { if(s.size && !sizes.includes(s.size)) sizes.push(s.size); if(s.color && !colors.includes(s.color)) colors.push(s.color); });
            let h = `<table class="st-table"><thead><tr><th>색상</th>${sizes.map(s=>`<th>${s}</th>`).join("")}</tr></thead><tbody>`;
            colors.forEach(c => { h += `<tr><td class="bg-light fw-bold">${c}</td>` + sizes.map(s => `<td>${stock.filter(x=>x.color===c && x.size===s).reduce((a,b)=>a+Number(b.qty),0) || 0}</td>`).join("") + "</tr>"; });
            document.getElementById("v-stock-table").innerHTML = h + "</tbody></table>";
            
            // 착장 정보
            const outfits = allOutfits.filter(o => o.code == i.code);
            document.getElementById("v-outfit-container").innerHTML = outfits.map((o, idx) => `
                <div class="info-item-card">
                    <button class="delete-btn" onclick="deleteInfo('outfit', '${o.code}', '${o.host}')">×</button>
                    <span class="info-card-top">${o.host}</span>
                    <span class="info-card-bottom">${o.size}</span>
                </div>`).join("") || '<div class="col-12 py-1 text-muted small">정보 없음</div>';
            
            // 대여 현황
            const rentals = allRentals.filter(r => r.code == i.code);
            document.getElementById("v-rental-list").innerHTML = rentals.map((r, idx) => `
                <div class="info-item-card">
                    <button class="delete-btn" onclick="deleteInfo('rental', '${r.code}', '${r.renter}', '${r.color}')">×</button>
                    <span class="info-card-top">${r.renter}</span>
                    <span class="info-card-bottom">${r.color}/${r.size}(${r.qty})</span>
                </div>`).join("") || '<div class="col-12 py-1 text-muted small">정보 없음</div>';
        }

        // --- 추가/삭제 비즈니스 로직 (깃허브 API 연동) ---

        function addOutfitData() {
            const host = prompt("성함:");
            const size = prompt("사이즈:");
            if(host && size) {
                allOutfits.push({ code: curItem.code, host, size });
                saveToGitHub("outfits.json", allOutfits);
            }
        }

        function addRentalData() {
            const renter = prompt("대여자:");
            const color = prompt("색상:");
            const size = prompt("사이즈:");
            const qty = prompt("수량:", "1");
            if(renter && color && size) {
                allRentals.push({ code: curItem.code, renter, color, size, qty });
                saveToGitHub("rentals.json", allRentals);
            }
        }

        function deleteInfo(type, code, key, color) {
            if(!confirm("삭제하시겠습니까?")) return;
            if(type === 'outfit') {
                allOutfits = allOutfits.filter(o => !(o.code === code && o.host === key));
                saveToGitHub("outfits.json", allOutfits);
            } else {
                allRentals = allRentals.filter(r => !(r.code === code && r.renter === key && r.color === color));
                saveToGitHub("rentals.json", allRentals);
            }
        }

        function resetFilter() {
            const b = document.getElementById("brandSel").value, c = document.getElementById("cateSel").value, q = document.getElementById("invSearch").value.toLowerCase();
            filteredItems = allItems.filter(i => i.isMaster && (b === 'All' || i.brand === b) && (c === 'All' || i.category === c) && (i.name.toLowerCase().includes(q) || i.brand.toLowerCase().includes(q) || i.code.toLowerCase().includes(q)));
            document.getElementById("inventoryContainer").innerHTML = ""; renderInventoryChunk();
        }

        function renderInventoryChunk() {
            const c = document.getElementById("inventoryContainer"), current = c.children.length;
            filteredItems.slice(current, current + 40).forEach(i => c.appendChild(createCard(i)));
            document.getElementById("loadMoreContainer").innerHTML = filteredItems.length > c.children.length ? `<button class="btn btn-outline-primary rounded-pill px-4 btn-sm" onclick="renderInventoryChunk()">더 보기</button>` : "";
        }

        function parseTime(s) { if(!s) return 9999; const m = s.match(/(\d{1,2}):(\d{1,2})/); return m ? parseInt(m[1])*60+parseInt(m[2]) : 9999; }
    </script>
</body>
</html>
