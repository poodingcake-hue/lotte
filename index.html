<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
      :root { --primary: #4361ee; --bg: #f8f9fa; --text: #212529; }
      body { font-family: 'Pretendard', sans-serif; background-color: var(--bg); color: var(--text); padding-bottom: 55px; margin: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
      .app-header { background: white; padding: 15px 20px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
      .app-title { font-size: 1.1rem; font-weight: 800; color: var(--primary); margin: 0; }
      .date-scroller { display: flex; overflow-x: auto; padding: 12px 10px; gap: 10px; background: white; border-bottom: 1px solid #eee; -webkit-overflow-scrolling: touch; position: sticky; top: 0; z-index: 1000; }
      .date-scroller::-webkit-scrollbar { display: none; }
      .date-btn { min-width: 50px; height: 60px; background: #f1f3f5; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; flex-shrink: 0; border: none; }
      .date-btn.active { background: var(--primary); color: white; }
      .date-btn .dow { font-size: 10px; opacity: 0.8; }
      .date-btn .day { font-size: 16px; font-weight: 700; }
      .filter-bar { background: white; padding: 8px 15px; display: flex; gap: 8px; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 999; }
      .filter-bar select { border-radius: 8px; font-size: 13px; border: 1px solid #ddd; height: 34px; }
      .product-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 12px; }
      .p-card { background: white; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; height: 100%; box-shadow: 0 2px 6px rgba(0,0,0,0.04); position: relative; }
      .p-img-box { position: relative; width: 100%; aspect-ratio: 1/1; background: #fff; display: flex; align-items: center; justify-content: center; }
      .p-img { width: 100%; height: 100%; object-fit: contain; }
      .p-info { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; }
      .p-brand { font-size: 11px; color: var(--primary); font-weight: 700; margin-bottom: 3px; }
      .p-name { font-size: 13px; font-weight: 600; line-height: 1.35; color: #333; min-height: 35px; max-height: 35px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; margin-bottom: 10px; }
      .p-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: center; padding-top: 8px; border-top: 1px solid #f1f1f1; }
      .p-loc { font-size: 10px; background: #f1f3f5; padding: 2px 5px; border-radius: 4px; color: #666; font-weight: 600; }
      .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; height: 50px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1001; }
      .nav-btn { flex: 1; border: none; background: none; color: #adb5bd; display: flex; align-items: center; justify-content: center; outline: none; transition: 0.2s; }
      .nav-btn.active { color: var(--primary); background: #f8faff; border-top: 2px solid var(--primary); }
      .nav-btn span { font-size: 14px; font-weight: 700; }

      /* 모달 스타일 */
      .modal-content { border-radius: 20px; border: none; overflow: hidden; }
      .modal-body { padding: 0; }
      .modal-img-wrap { width: 100%; background: #fff; border-bottom: 1px solid #eee; position: relative; cursor: pointer; }
      #m-img { width: 100%; height: auto; max-height: 45vh; object-fit: contain; }
      .m-product-info-top { font-size: 12px; color: #888; margin: 15px 20px 4px; line-height: 1.2; }
      .m-product-info-top b { color: #222; font-weight: 800; }
      .m-product-title { font-size: 14px; font-weight: 700; color: #111; margin: 0 20px 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
      
      /* 입력창 그룹 패딩 */
      .modal-main-padding { padding: 0 20px; }
      .loc-input-group { background: #f8f9fa; padding: 12px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eee; }
      .loc-input-group label { font-size: 11px; font-weight: 700; color: var(--primary); display: block; margin-bottom: 5px; }
      .loc-input-group input { width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 8px; font-size: 14px; outline: none; }

      /* [핵심] 재고표 스타일 수정: 여백 제거 및 너비 최대화 */
      .table-full-container { margin: 0; padding: 0; width: 100%; overflow-x: auto; }
      .st-table { 
        font-size: 10px !important; /* 상품코드 크기만큼 축소 */
        width: 100% !important; 
        margin: 0 !important; 
        border-collapse: collapse; 
        table-layout: fixed; /* 너비 고정을 위해 필수 */
        border-left: none !important;
        border-right: none !important;
      }
      .st-table th, .st-table td { 
        border: 1px solid #eee; 
        padding: 8px 2px; 
        text-align: center; 
        vertical-align: middle;
        overflow: hidden;
      }
      /* 색상 컬럼: 22vw 고정 및 글씨 자동 축소 방지용 설정 */
      .col-color { 
        width: 22vw !important; 
        white-space: nowrap !important; 
        text-overflow: clip;
        font-size: 9px !important; /* 색상명은 조금 더 작게 해서 한줄 유지 */
        font-weight: 600;
        background-color: #fcfcfc;
      }
      .st-table input { 
        width: 100%; 
        border: none; 
        text-align: center; 
        font-size: 11px; 
        outline: none; 
        background: transparent;
        padding: 0;
      }
      .st-table th { background: #f8f9fa; font-weight: 700; color: #666; }

      #loading-overlay { position: fixed; inset: 0; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
      .spinner { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .time-label { font-size: 16px; font-weight: 800; margin: 5px 12px 10px; display: flex; align-items: center; gap: 8px; }
      .time-label::after { content: ""; flex-grow: 1; height: 1px; background: #ddd; }
    </style>
  </head>
  <body>
    <div id="loading-overlay"><div class="spinner"></div><div class="small">데이터 로딩 중...</div></div>
    <div id="page-schedule"><div class="date-scroller" id="dateScroller"></div><div id="scheduleContainer"></div></div>
    <div id="page-inventory" style="display:none;"><div class="filter-bar"><select id="brandSel" class="form-select form-select-sm" onchange="filterInventory()"></select><select id="cateSel" class="form-select form-select-sm" onchange="filterInventory()"></select></div><div id="inventoryContainer" class="product-grid"></div></div>
    <nav class="bottom-nav"><button class="nav-btn active" id="nav-sch" onclick="switchTab('schedule')"><span>편성표</span></button><button class="nav-btn" id="nav-inv" onclick="switchTab('inventory')"><span>재고관리</span></button></nav>
    
    <div class="modal fade" id="itemModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down"><div class="modal-content"><div class="modal-body">
      <div class="modal-img-wrap mb-2" onclick="openLotteMall()"><img id="m-img" src=""><button type="button" class="btn-close" data-bs-dismiss="modal" style="position:absolute; top:15px; right:15px; background:white; border-radius:50%; padding:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1);"></button></div>
      <div class="m-product-info-top" id="m-info-top"></div>
      <div class="m-product-title" id="m-title"></div>
      
      <!-- 탭 메뉴는 기존 패딩 유지 -->
      <div class="modal-main-padding">
        <ul class="nav nav-pills nav-fill mb-3 bg-light p-1 rounded-pill">
          <li class="nav-item"><button class="nav-link active rounded-pill py-2 small" id="t-view" onclick="toggleModalView('view')">재고 현황</button></li>
          <li class="nav-item"><button class="nav-link rounded-pill py-2 small" id="t-add" onclick="toggleModalView('add')">입고 등록</button></li>
        </ul>
      </div>

      <!-- 재고 현황 (여백 없음) -->
      <div id="v-view" class="table-full-container"></div>

      <!-- 입고 등록 (여백 없음) -->
      <div id="v-add" style="display:none;">
         <div class="modal-main-padding">
           <div class="loc-input-group"><label>입고 위치 입력 (G열 저장)</label><input type="text" id="in-location" placeholder="예: 행거A1-1"></div>
         </div>
         <div id="add-table-container" class="table-full-container"></div>
         <div class="modal-main-padding">
           <div class="d-flex gap-2 mt-3 mb-4"><button class="btn btn-sm btn-outline-secondary w-100 py-2" onclick="addRow()">+ 색상</button><button class="btn btn-sm btn-outline-secondary w-100 py-2" onclick="addCol()">+ 사이즈</button></div>
         </div>
      </div>
    </div><div class="modal-footer border-0"><button type="button" class="btn btn-primary w-100 py-2" id="btn-save" style="display:none;" onclick="saveData()">저장</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_URL = "https://script.google.com/macros/s/AKfycbzpAjxDWvpV8BLsMiezsBSTINg6tIe18OyJkz4pDuChnToiVajjt5BmZWAuVrnl7Eh1/exec";
      let curItem = null, allItems = [], selDate = null, modalObj = null;

      google.script.history.setChangeHandler(function(e) {
        const h = e.location.hash;
        if (h !== 'modal' && document.getElementById('itemModal').classList.contains('show')) { modalObj.hide(); }
        if (!h) { switchTabUI('schedule'); } else if (h === 'inventory') { switchTabUI('inventory'); }
      });

      window.onload = function() { google.script.run.withSuccessHandler(onDataLoad).getInitialData(); };

      function onDataLoad(data) {
        allItems = data.items || [];
        modalObj = new bootstrap.Modal(document.getElementById('itemModal'));
        const b = document.getElementById("brandSel"), c = document.getElementById("cateSel");
        b.innerHTML = '<option value="All">전체 브랜드</option>';
        c.innerHTML = '<option value="All">전체 카테고리</option>';
        data.brands.forEach(v => b.add(new Option(v, v)));
        data.categories.forEach(v => c.add(new Option(v, v)));
        if(data.dates.length > 0) {
          const scroller = document.getElementById("dateScroller");
          scroller.innerHTML = ""; selDate = data.dates[0];
          data.dates.forEach(d => {
            const dateObj = new Date(d);
            const btn = document.createElement("div");
            btn.className = `date-btn ${d === selDate ? 'active' : ''}`;
            btn.innerHTML = `<span class="dow">${"일월화수목금토"[dateObj.getDay()]}</span><span class="day">${dateObj.getDate()}</span>`;
            btn.onclick = () => { document.querySelectorAll('.date-btn').forEach(el => el.classList.remove('active')); btn.classList.add('active'); selDate = d; renderSchedule(); };
            scroller.appendChild(btn);
          });
        }
        renderSchedule(); filterInventory();
        document.getElementById('loading-overlay').style.display = 'none';
      }

      function switchTab(t) {
        if (t === 'inventory') { google.script.history.push(null, null, 'inventory'); }
        else { google.script.history.push(null, null, ''); }
        switchTabUI(t);
      }
      function switchTabUI(t) {
        document.getElementById('page-schedule').style.display = t === 'schedule' ? 'block' : 'none';
        document.getElementById('page-inventory').style.display = t === 'inventory' ? 'block' : 'none';
        document.getElementById('nav-sch').classList.toggle('active', t === 'schedule');
        document.getElementById('nav-inv').classList.toggle('active', t === 'inventory');
      }

      function openModal(item) {
        curItem = item;
        document.getElementById("m-info-top").innerHTML = `<b>${item.brand}</b> | ${item.code} | <b>${item.location || '-'}</b>`;
        document.getElementById("m-title").innerText = item.name.replace(/(\r\n|\n|\r)/gm, " ");
        document.getElementById("m-img").src = item.image;
        document.getElementById("in-location").value = (item.location === "-" ? "" : item.location);
        toggleModalView('view');
        document.getElementById("v-view").innerHTML = "<div class='text-center py-4 small'>조회 중...</div>";
        fetchData("getExistingStock", `&code=${item.code}`);
        
        const colors = (item.colors || "기본").split(","), sizes = (item.sizes || "Free").split(",");
        let ah = `<table class="st-table" id="add-table"><thead><tr><th class="col-color">색상</th>${sizes.map(s=>`<th><input type="text" value="${s.trim()}" style="font-weight:bold;"></th>`).join("")}</tr></thead><tbody>`;
        colors.forEach(c => { ah += `<tr><td class="col-color">${c.trim()}</td>` + sizes.map(()=>`<td><input type="number"></td>`).join("") + "</tr>"; });
        document.getElementById("add-table-container").innerHTML = ah + "</tbody></table>";
        
        google.script.history.push(null, null, 'modal');
        modalObj.show();
      }

      function renderStock(stock) {
        const container = document.getElementById("v-view");
        if(!stock.length) { container.innerHTML = "<div class='text-center py-4 small'>재고 없음</div>"; return; }
        const sizes = [...new Set(stock.map(s => s.size))], colors = [...new Set(stock.map(s => s.color))];
        let h = `<table class="st-table"><thead><tr><th class="col-color">색상</th>${sizes.map(s=>`<th>${s}</th>`).join("")}</tr></thead><tbody>`;
        colors.forEach(c => { h += `<tr><td class="col-color">${c}</td>` + sizes.map(s => { const q = stock.filter(x => x.color === c && x.size === s).reduce((a, b) => a + Number(b.qty), 0); return `<td>${q || 0}</td>`; }).join("") + "</tr>"; });
        container.innerHTML = h + "</tbody></table>";
      }

      function fetchData(action, params = "") {
        fetch(`${API_URL}?action=${action}${params}`)
          .then(res => res.json())
          .then(data => {
            if (action == "getInitialData") onDataLoad(data);
            else if (action == "getExistingStock") renderStock(data);
            else if (action == "saveInventoryData") { alert(data); modalObj.hide(); fetchData("getInitialData"); }
          });
      }

      function saveData() {
        const table = document.getElementById("add-table"), headers = Array.from(table.rows[0].cells).slice(1).map(c => c.querySelector("input").value.trim());
        const loc = document.getElementById("in-location").value.trim(), matrix = [];
        for(let i=1; i<table.rows.length; i++) {
          const color = table.rows[i].cells[0].innerText.trim();
          if(!color) continue;
          headers.forEach((size, idx) => {
            const qty = table.rows[i].cells[idx+1].querySelector("input").value;
            if(qty && Number(qty) > 0) matrix.push({ color, size, qty: Number(qty) });
          });
        }
        if(matrix.length === 0) return alert("수량을 입력하세요.");
        const combined = curItem.brand + " " + curItem.name;
        google.script.run.withSuccessHandler(res => { alert(res); modalObj.hide(); fetchData("getInitialData"); }).saveInventoryData({ code: curItem.code, combinedName: combined, name: curItem.name, matrix: matrix, location: loc });
      }

      function filterInventory() {
        const b = document.getElementById("brandSel").value, c = document.getElementById("cateSel").value;
        const filtered = allItems.filter(i => (b==='All' || i.brand === b) && (c==='All' || i.category === c));
        const container = document.getElementById("inventoryContainer");
        container.innerHTML = filtered.length ? "" : '<div class="text-center py-5 small w-100">상품 없음</div>';
        filtered.forEach(i => container.appendChild(createCard(i)));
      }
      function renderSchedule() {
        const container = document.getElementById("scheduleContainer"); container.innerHTML = "";
        const filtered = allItems.filter(i => i.dateKey === selDate).sort((a,b) => parseTime(a.date) - parseTime(b.date));
        if (!filtered.length) { container.innerHTML = '<div class="text-center py-5 small">편성 없음</div>'; return; }
        const groups = {};
        filtered.forEach(i => {
          const t = i.date && i.date.match(/\d{1,2}:\d{1,2}/) ? i.date.match(/\d{1,2}:\d{1,2}/)[0] : "시간미정";
          if(!groups[t]) groups[t] = []; groups[t].push(i);
        });
        Object.keys(groups).forEach(t => {
          const g = document.createElement("div"); g.innerHTML = `<div class="time-label">${t}</div>`;
          const grid = document.createElement("div"); grid.className = "product-grid";
          groups[t].forEach(item => grid.appendChild(createCard(item)));
          g.appendChild(grid); container.appendChild(g);
        });
      }
      function createCard(item) {
        const div = document.createElement("div"); div.className = "p-card"; div.onclick = () => openModal(item);
        const timeMatch = item.date && item.date.match(/\d{1,2}:\d{1,2}/);
        div.innerHTML = `<div class="p-img-box">${timeMatch ? `<div class="b-badge">${timeMatch[0]}</div>` : ''}<img src="${item.image}" class="p-img" loading="lazy"></div><div class="p-info"><div class="p-brand">${item.brand || ""}</div><div class="p-name">${item.name || ""}</div><div class="p-footer"><span class="p-loc">${item.location || "-"}</span></div></div>`;
        return div;
      }
      function toggleModalView(v) {
        document.getElementById('v-view').style.display = v === 'view' ? 'block' : 'none';
        document.getElementById('v-add').style.display = v === 'add' ? 'block' : 'none';
        document.getElementById('btn-save').style.display = v === 'add' ? 'block' : 'none';
        document.getElementById('t-view').classList.toggle('active', v === 'view');
        document.getElementById('t-add').classList.toggle('active', v === 'add');
      }
      function openLotteMall() { if(!curItem || !curItem.code) return; window.open("https://www.lotteimall.com/goods/viewGoodsDetail.lotte?goods_no=" + curItem.code, '_blank'); }
      function parseTime(s) { if(!s) return 9999; const m = s.match(/(\d{1,2}):(\d{1,2})/); if(!m) return 9999; let h = parseInt(m[1]), min = parseInt(m[2]); if(s.includes("오후") && h < 12) h += 12; if(s.includes("오전") && h === 12) h = 0; return h * 60 + min; }
      function addRow() { const table = document.getElementById("add-table"), row = table.insertRow(); row.innerHTML = `<td class="col-color"><input type="text" placeholder="색상"></td>` + `<td><input type="number"></td>`.repeat(table.rows[0].cells.length - 1); }
      function addCol() { const table = document.getElementById("add-table"), th = document.createElement("th"); th.innerHTML = `<input type="text" placeholder="사이즈">`; table.rows[0].appendChild(th); for(let i=1; i<table.rows.length; i++) { table.rows[i].insertCell().innerHTML = `<input type="number">`; } }
    </script>
  </body>
</html>

</html>
